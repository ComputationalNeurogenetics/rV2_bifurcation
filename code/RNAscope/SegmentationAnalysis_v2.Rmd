---
title: "R Notebook of analysis of Stardist segmented cells from RNAscope images"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  html_notebook:
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
cache: true
cache_dir: "cache"  # Specify custom cache directory
cache.lazy: false 
---

```{r, message=FALSE}
Sys.setlocale("LC_TIME", "en_US.UTF-8")
library("RImageJROI")
library(raster)
library(spatstat.utils)
library(spatstat)
library(tidyverse)
library(PerformanceAnalytics)
library(parallel)
library(factoextra)
library(viridis)
library(broom)
library(mgcv)
library(slider)

source("CellAuxFunctions.R")
cores<-10
```

```{r}
knitr::opts_chunk$set(cache.path = "./")
```

```{r Image paths}
rois.path <- "/Volumes/MyBookDuo/DataLad/RNAScope_images/to_segment/TIFF/"
fluor.channel.path <- "/Volumes/MyBookDuo/DataLad/RNAScope_images/fluor_channels/"
```

```{r}
image_bases <- image_bases <- c(
  "e3_1a_sb514_e12.5_63x", "e3_3b_sb509_e12.5_63x", "e3_1a_sb510_e12.5_63x",
  "e3b_1b_sb514_e12.5_63x", "e3b_3b_sb509_e12.5_63x", "e3b_1b_sb510_e12.5_63x",
  "e4_1c_sb514_e12.5_63x", "e4_3e_sb509_e12.5_63x", "e4_1c_sb510_e12.5_63x",
  "e4_2b_sb0488_e12.5_63x", "e4_4c_sb0479_e12.5_63x"
)
rois.trail <- "_dapi.tif_rois.zip"

# Call the function to calculate the global average cell diameter
global_avg_diameter <- calculate_global_average_diameter(image_bases, rois_path = rois.path, rois_trail = rois.trail)
print(global_avg_diameter)
```


# Image e3_1a_sb514 {.tabset}

```{r}
rois.trail <- "_dapi.tif_rois.zip"
band.trail.1 <- "_Tal1.tif"
band.trail.2 <- "_Insm1.tif"
band.trail.3 <- "_Sox4.tif"
dapi.trail <- "_dapi.tif"
image.base <- "e3_1a_sb514_e12.5_63x"
```

```{r Reading imageJ ROIS file for a image e3_1a_sb514}
rois <- read.ijzip(file = paste(rois.path,image.base,rois.trail,sep=""))
rois.ss <- ij2spatstat(rois)
```

```{r Reading channels from image files e3_1a_sb514, warning=FALSE}
ras.1 <- flip(raster(paste(fluor.channel.path,image.base,band.trail.1,sep=""), band=1), direction="y")
ras.2 <- flip(raster(paste(fluor.channel.path,image.base,band.trail.3,sep=""), band=3), direction="y")
ras.3 <- flip(raster(paste(fluor.channel.path,image.base,band.trail.2,sep=""), band=2), direction="y")
ras.dapi <- flip(raster(paste(fluor.channel.path,image.base,dapi.trail,sep=""), band=1),direction="y")

im.1 <- as.im(as.matrix(flip(ras.1)))
im.2 <- as.im(as.matrix(flip(ras.2)))
im.3 <- as.im(as.matrix(flip(ras.3)))
im.dapi <- as.im(as.matrix(flip(ras.dapi)))
```

## Segmentation and channels check

```{r Plot DAPI channel to check orientation e3_1a_sb514}
plot(im.dapi)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```

```{r Plot channel 1 to check orientation e3_1a_sb514}
plot(im.1)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```
```{r Plot channel 2 to check orientation e3_1a_sb514}
plot(im.2)
plot(rois, TRUE,xlim=c(0, ras.2@extent@xmax), ylim=c(ras.2@extent@ymax, 0))
```

```{r Plot channel 3 to check orientation e3_1a_sb514}
plot(im.3)
plot(rois, TRUE,xlim=c(0, ras.3@extent@xmax), ylim=c(ras.3@extent@ymax, 0))
```

```{r Define VZ e3_1a_sb514, eval=FALSE}
plot(im.dapi)
three.points <- locator()
saveRDS(three.points,file="../../analysis/e3_1a_sb514.three.points.Rds")
```

```{r}
three.points <- readRDS(file="../../analysis/e3_1a_sb514.three.points.Rds")
```

```{r Process e3_1a_sb514}
count.per.cell.channel.filt.e3_1a_sb514 <- process_image_data(
  rois.ss = rois.ss, 
  im.1 = im.1, 
  im.2 = im.2, 
  im.3 = im.3, 
  rois = rois, 
  three.points = three.points, 
  cores = cores, 
  replicate_name = "e3_1a_sb514", 
  quantile_threshold = 0.25,
  cell.size.avg = global_avg_diameter
)
```

## Fluorescence from VZ

```{r}
ggplot(count.per.cell.channel.filt.e3_1a_sb514, aes(x=cell.distances,y=count.dots)) + geom_point(aes(colour = factor(ch))) + scale_color_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Sox4","Insm1")) + labs(color="Channel") + theme_minimal() +ggtitle("Raw values") + xlab("Average cell diameters from VZ")
```


```{r}
plot_sliding_mean(count.per.cell.channel.filt.e3_1a_sb514, window_size = 8)
``` 

## Stacked barplot of fluor dot proportions as distance from VZ

```{r fig.width=12, fig.height=4}
ggplot(count.per.cell.channel.filt.e3_1a_sb514, aes(fill=as.character(ch), y=norm_count_dots, x=cell.distances)) + geom_bar(position="stack", width = 1,stat="identity") + scale_fill_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Sox4","Insm1")) + theme_minimal()  + theme(axis.text.x = element_blank()) + labs(fill="Channel") + xlab("Cells in increasing distance from VZ (as units of average cell size) from VZ (as units of average cell size)")
```

# Image e3_3b_sb509 {.tabset}

```{r}
rois.trail <- "_dapi.tif_rois.zip"
band.trail.1 <- "_Tal1.tif"
band.trail.2 <- "_Insm1.tif"
band.trail.3 <- "_Sox4.tif"
dapi.trail <- "_dapi.tif"
image.base <- "e3_3b_sb509_e12.5_63x"
```

```{r Reading imageJ ROIS file for a image e3_3b_sb509}
rois <- read.ijzip(file = paste(rois.path,image.base,rois.trail,sep=""))
rois.ss <- ij2spatstat(rois)
```

```{r Reading channels from image files e3_3b_sb509, warning=FALSE}
ras.1 <- flip(raster(paste(fluor.channel.path,image.base,band.trail.1,sep=""), band=1), direction="y")
ras.2 <- flip(raster(paste(fluor.channel.path,image.base,band.trail.3,sep=""), band=3), direction="y")
ras.3 <- flip(raster(paste(fluor.channel.path,image.base,band.trail.2,sep=""), band=2), direction="y")
ras.dapi <- flip(raster(paste(fluor.channel.path,image.base,dapi.trail,sep=""), band=1),direction="y")

im.1 <- as.im(as.matrix(ras.1))
im.2 <- as.im(as.matrix(ras.2))
im.3 <- as.im(as.matrix(ras.3))
im.dapi <- as.im(as.matrix(ras.dapi))
```

## Segmentation and channels check

```{r Plot DAPI channel to check orientation e3_3b_sb509}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.dapi)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```


```{r Plot channel 1 to check orientation e3_3b_sb509}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.1)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```

```{r Plot channel 2 to check orientation e3_3b_sb509}
plot(im.2)
plot(rois, TRUE,xlim=c(0, ras.2@extent@xmax), ylim=c(ras.2@extent@ymax, 0))
```

```{r Plot channel 3 to check orientation e3_3b_sb509}
plot(im.3)
plot(rois, TRUE,xlim=c(0, ras.3@extent@xmax), ylim=c(ras.3@extent@ymax, 0))
```

```{r Define circle e3_3b_sb509, eval=FALSE}
plot(im.dapi)
three.points <- locator()
saveRDS(three.points,file="../../analysis/e3_1a_sb510.three.points.Rds")
```

```{r}
three.points <- readRDS(file="../../analysis/e3_1a_sb510.three.points.Rds")
```

```{r Process e3_3b_sb509}
count.per.cell.channel.filt.e3_3b_sb509 <- process_image_data(
  rois.ss = rois.ss, 
  im.1 = im.1, 
  im.2 = im.2, 
  im.3 = im.3, 
  rois = rois, 
  three.points = three.points, 
  cores = cores, 
  replicate_name = "e3_3b_sb509", 
  quantile_threshold = 0.25,
  cell.size.avg = global_avg_diameter
)
```

## Fluorescence from VZ

```{r}
ggplot(count.per.cell.channel.filt.e3_3b_sb509, aes(x=cell.distances,y=count.dots)) + geom_point(aes(colour = factor(ch))) + scale_color_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Sox4","Insm1")) + labs(color="Channel") + theme_minimal() +ggtitle("Raw values") + xlab("Micrometers")
```

```{r}
plot_sliding_mean(count.per.cell.channel.filt.e3_3b_sb509, window_size = 8)
```


## Stacked barplot of fluor dot proportions as distance from VZ

```{r fig.width=12, fig.height=4}
ggplot(count.per.cell.channel.filt.e3_3b_sb509, aes(fill=as.character(ch), y=norm_count_dots, x=cell.distances)) + geom_bar(position="stack", width = 1,stat="identity") + scale_fill_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Sox4","Insm1")) + theme_minimal()  + theme(axis.text.x = element_blank()) + labs(fill="Channel") + xlab("Cells in increasing distance from VZ (as units of average cell size) from VZ (as units of average cell size)")
```

# Image e3_1a_sb510 {.tabset}

```{r}
rois.trail <- "_dapi.tif_rois.zip"
band.trail.1 <- "_Tal1.tif"
band.trail.2 <- "_Insm1.tif"
band.trail.3 <- "_Sox4.tif"
dapi.trail <- "_dapi.tif"
image.base <- "e3_1a_sb510_e12.5_63x"
```

```{r Reading imageJ ROIS file for a image e3_1a_sb510}
rois <- read.ijzip(file = paste(rois.path,image.base,rois.trail,sep=""))
rois.ss <- ij2spatstat(rois)
```

```{r Reading channels from image files e3_1a_sb510, warning=FALSE}
ras.1 <- raster(paste(fluor.channel.path,image.base,band.trail.1,sep=""), band=1)
ras.2 <- raster(paste(fluor.channel.path,image.base,band.trail.3,sep=""), band=3)
ras.3 <- raster(paste(fluor.channel.path,image.base,band.trail.2,sep=""), band=2)
ras.dapi <- raster(paste(fluor.channel.path,image.base,dapi.trail,sep=""), band=1)

im.1 <- as.im(as.matrix(flip(ras.1,direction='x')))
im.2 <- as.im(as.matrix(flip(ras.2,direction='x')))
im.3 <- as.im(as.matrix(flip(ras.3,direction='x')))
im.dapi <- as.im(as.matrix(flip(ras.dapi,direction='x')))
```

## Segmentation and channels check

```{r Plot DAPI channel to check orientation e3_1a_sb510}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.dapi)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```


```{r Plot channel 1 to check orientation e3_1a_sb510}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.1)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```

```{r Plot channel 2 to check orientation e3_1a_sb510}
plot(im.2)
plot(rois, TRUE,xlim=c(0, ras.2@extent@xmax), ylim=c(ras.2@extent@ymax, 0))
```

```{r Plot channel 3 to check orientation e3_1a_sb510}
plot(im.3)
plot(rois, TRUE,xlim=c(0, ras.3@extent@xmax), ylim=c(ras.3@extent@ymax, 0))
```



```{r Define circle e3_1a_sb510, eval=FALSE}
plot(im.dapi)
three.points <- locator()
saveRDS(three.points,file="../../analysis/e3_1a_sb510.three.points.Rds")
```

```{r}
three.points <- readRDS(file="../../analysis/e3_1a_sb510.three.points.Rds")
```

```{r Process e3_1a_sb510}
count.per.cell.channel.filt.e3_1a_sb510 <- process_image_data(
  rois.ss = rois.ss, 
  im.1 = im.1, 
  im.2 = im.2, 
  im.3 = im.3, 
  rois = rois, 
  three.points = three.points, 
  cores = cores, 
  replicate_name = "e3_1a_sb510", 
  quantile_threshold = 0.25,
  cell.size.avg = global_avg_diameter
)
```

## Fluorescence from VZ

```{r}
ggplot(count.per.cell.channel.filt.e3_1a_sb510, aes(x=cell.distances,y=count.dots)) + geom_point(aes(colour = factor(ch))) + scale_color_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Sox4","Insm1")) + labs(color="Channel") + theme_minimal() +ggtitle("Raw values") + xlab("Micrometers")
```

```{r}
plot_sliding_mean(count.per.cell.channel.filt.e3_1a_sb510, window_size = 8)
```

## Stacked barplot of fluor dot proportions as distance from VZ

```{r fig.width=12, fig.height=4}
ggplot(filter(count.per.cell.channel.filt.e3_1a_sb510,norm_count_dots <=1 & !is.na(norm_count_dots)), aes(fill=as.character(ch), y=norm_count_dots, x=cell.distances)) + geom_bar(position="stack", width = 1,stat="identity") + scale_fill_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Sox4","Insm1")) + theme_minimal()  + theme() + labs(fill="Channel") + xlab("Cells in increasing distance from VZ (as units of average cell size) from VZ (as units of average cell size)")
```

# e3 aggregated

```{r, fig.width=10}
# Combine replicates first
combined_replicates <- rbind(count.per.cell.channel.filt.e3_1a_sb510, 
                             count.per.cell.channel.filt.e3_3b_sb509, 
                             count.per.cell.channel.filt.e3_1a_sb514)

combined_replicates <- filter_by_max_distance(combined_replicates)

plot_sliding_mean_replicates(combined_replicates, window_size = 8)
```

```{r}
# Normalize within each channel for each replicate
slided.tb <- combined_replicates %>%
  group_by(replicate, ch) %>%
  mutate(count.dots_norm = (count.dots - mean(count.dots)) / sd(count.dots)) %>%
  ungroup()

# Apply symmetrical sliding window to count.dots_norm
slided.tb <- apply_sliding_window(slided.tb, window_size = 8)

# 2. Remove any remaining NAs after the sliding window process
slided.tb <- na.omit(slided.tb)

# Convert replicate to a factor if it's not already
slided.tb$replicate <- as.factor(slided.tb$replicate)

# Fit the updated GAMM model with replicate and channel
gam_model_both_updated <- gam(count.dots_norm_slid ~ replicate + ch + 
                              s(cell.distances, bs = "cr") +         # Overall smooth term for distance
                              s(cell.distances, by = replicate, bs = "cr") +   # Smooth term per replicate
                              s(cell.distances, by = ch, bs = "cr"),           # Smooth term per channel
                              data = slided.tb, method = "REML")

# Check the summary of the model
summary(gam_model_both_updated)
```

```{r}
# Extract parametric coefficients from the model summary
parametric_coefficients <- summary(gam_model_both_updated)$p.table

# Convert parametric coefficients to a tibble
parametric_tibble <- tibble::tibble(
  term = rownames(parametric_coefficients),
  estimate = parametric_coefficients[, 1],
  std.error = parametric_coefficients[, 2],
  statistic = parametric_coefficients[, 3],
  p.value = parametric_coefficients[, 4]
)

# Extract smooth terms from the model summary
smooth_terms <- summary(gam_model_both_updated)$s.table

# Convert smooth terms to a tibble
smooth_tibble <- tibble::tibble(
  term = rownames(smooth_terms),
  edf = smooth_terms[, 1],
  ref_df = smooth_terms[, 2],
  F_stat = smooth_terms[, 3],
  p_value = smooth_terms[, 4]
)

# Combine parametric and smooth terms into a neat tibble list
results_tibble <- list(
  "Parametric Coefficients" = parametric_tibble,
  "Smooth Terms" = smooth_tibble
)

# Display the results as two tibbles
results_tibble
```

# Image e3b_1b_sb514 {.tabset}

```{r}
rois.trail <- "_dapi.tif_rois.zip"
band.trail.1 <- "_Tal1.tif"
band.trail.2 <- "_Tead2.tif"
band.trail.3 <- "_E2f1.tif"
dapi.trail <- "_dapi.tif"
image.base <- "e3b_1b_sb514_e12.5_63x"
```

```{r Reading imageJ ROIS file for a image e3b_1b_sb514}
rois <- read.ijzip(file = paste(rois.path,image.base,rois.trail,sep=""))
rois.ss <- ij2spatstat(rois)
```

```{r Reading channels from image files e3b_1b_sb514, warning=FALSE}
ras.1 <- raster(paste(fluor.channel.path,image.base,band.trail.1,sep=""), band=1)
ras.2 <- raster(paste(fluor.channel.path,image.base,band.trail.2,sep=""), band=3)
ras.3 <- raster(paste(fluor.channel.path,image.base,band.trail.3,sep=""), band=2)
ras.dapi <- raster(paste(fluor.channel.path,image.base,dapi.trail,sep=""), band=1)

im.1 <- as.im(as.matrix(ras.1))
im.2 <- as.im(as.matrix(ras.2))
im.3 <- as.im(as.matrix(ras.3))
im.dapi <- as.im(as.matrix(ras.dapi))
```

## Segmentation and channels check

```{r Plot DAPI channel to check orientation e3b_1b_sb514}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.dapi)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```


```{r Plot channel 1 to check orientation e3b_1b_sb514}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.1)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```

```{r Plot channel 2 to check orientation e3b_1b_sb514}
plot(im.2)
plot(rois, TRUE,xlim=c(0, ras.2@extent@xmax), ylim=c(ras.2@extent@ymax, 0))
```

```{r Plot channel 3 to check orientation e3b_1b_sb514}
plot(im.3)
plot(rois, TRUE,xlim=c(0, ras.3@extent@xmax), ylim=c(ras.3@extent@ymax, 0))
```

```{r Define circle e3b_1b_sb514, eval=FALSE}
plot(im.dapi)
three.points <- locator()
saveRDS(three.points,file="../../analysis/e3b_1b_sb514.three.points.Rds")
```

```{r}
three.points <- readRDS(file="../../analysis/e3b_1b_sb514.three.points.Rds")
```

```{r Process e3b_1b_sb514}
count.per.cell.channel.filt.e3b_1b_sb514 <- process_image_data(
  rois.ss = rois.ss, 
  im.1 = im.1, 
  im.2 = im.2, 
  im.3 = im.3, 
  rois = rois, 
  three.points = three.points, 
  cores = cores, 
  replicate_name = "e3b_1b_sb514", 
  quantile_threshold = 0.25,
  cell.size.avg = global_avg_diameter
)
```

## Fluorescence from VZ

```{r}
ggplot(count.per.cell.channel.filt.e3b_1b_sb514, aes(x=cell.distances,y=count.dots)) + geom_point(aes(colour = factor(ch))) + scale_color_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","E2f1")) + labs(color="Channel") + theme_minimal() +ggtitle("Raw values") + xlab("")
```


```{r}
plot_sliding_mean(count.per.cell.channel.filt.e3b_1b_sb514, window_size = 8)
```


## Stacked barplot of fluor dot proportions as distance from VZ


```{r fig.width=12, fig.height=4}
ggplot(count.per.cell.channel.filt.e3b_1b_sb514, aes(fill=as.character(ch), y=norm_count_dots, x=cell.distances)) + geom_bar(position="stack", width = 1,stat="identity") + scale_fill_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","E2f1")) + theme_minimal()  + theme(axis.text.x = element_blank()) + labs(fill="Channel") + xlab("Cells in increasing distance from VZ (as units of average cell size)")
```


# Image e3b_3b_sb509 {.tabset}

```{r}
rois.trail <- "_dapi.tif_rois.zip"
band.trail.1 <- "_Tal1.tif"
band.trail.2 <- "_Tead2.tif"
band.trail.3 <- "_E2f1.tif"
dapi.trail <- "_dapi.tif"
image.base <- "e3b_3b_sb509_e12.5_63x"
```

```{r Reading imageJ ROIS file for a image e3b_3b_sb509}
rois <- read.ijzip(file = paste(rois.path,image.base,rois.trail,sep=""))
rois.ss <- ij2spatstat(rois)
```

```{r Reading channels from image files e3b_3b_sb509, warning=FALSE}
ras.1 <- raster(paste(fluor.channel.path,image.base,band.trail.1,sep=""), band=1)
ras.2 <- raster(paste(fluor.channel.path,image.base,band.trail.2,sep=""), band=3)
ras.3 <- raster(paste(fluor.channel.path,image.base,band.trail.3,sep=""), band=2)
ras.dapi <- raster(paste(fluor.channel.path,image.base,dapi.trail,sep=""), band=1)

im.1 <- as.im(as.matrix(ras.1))
im.2 <- as.im(as.matrix(ras.2))
im.3 <- as.im(as.matrix(ras.3))
im.dapi <- as.im(as.matrix(ras.dapi))
```

## Segmentation and channels check

```{r Plot DAPI channel to check orientation e3b_3b_sb509}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.dapi)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```


```{r Plot channel 1 to check orientation e3b_3b_sb509}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.1)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```

```{r Plot channel 2 to check orientation e3b_3b_sb509}
plot(im.2)
plot(rois, TRUE,xlim=c(0, ras.2@extent@xmax), ylim=c(ras.2@extent@ymax, 0))
```

```{r Plot channel 3 to check orientation e3b_3b_sb509}
plot(im.3)
plot(rois, TRUE,xlim=c(0, ras.3@extent@xmax), ylim=c(ras.3@extent@ymax, 0))
```

```{r Define circle e3b_3b_sb509, eval=FALSE}
plot(im.dapi)
three.points <- locator()
saveRDS(three.points,file="../../analysis/e3b_3b_sb509.three.points.Rds")
```

```{r}
three.points <- readRDS(file="../../analysis/e3b_3b_sb509.three.points.Rds")
```

```{r Process e3b_3b_sb509}
count.per.cell.channel.filt.e3b_3b_sb509 <- process_image_data(
  rois.ss = rois.ss, 
  im.1 = im.1, 
  im.2 = im.2, 
  im.3 = im.3, 
  rois = rois, 
  three.points = three.points, 
  cores = cores, 
  replicate_name = "e3b_3b_sb509", 
  quantile_threshold = 0.25,
  cell.size.avg = global_avg_diameter
)
```

## Fluorescence from VZ

```{r}
ggplot(count.per.cell.channel.filt.e3b_3b_sb509, aes(x=cell.distances,y=count.dots)) + geom_point(aes(colour = factor(ch))) + scale_color_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","E2f1")) + labs(color="Channel") + theme_minimal() +ggtitle("Raw values") + xlab("Micrometers")
```

```{r}
plot_sliding_mean(count.per.cell.channel.filt.e3b_3b_sb509, window_size = 8)
```

plot(im.dapi)
## Stacked barplot of fluor dot proportions as distance from VZ

```{r fig.width=12, fig.height=4}
ggplot(count.per.cell.channel.filt.e3b_3b_sb509, aes(fill=as.character(ch), y=norm_count_dots, x=cell.distances)) + geom_bar(position="stack", width = 1,stat="identity") + scale_fill_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","E2f1")) + theme_minimal()  + theme(axis.text.x = element_blank()) + labs(fill="Channel") + xlab("Cells in increasing distance from VZ (as units of average cell size)")
```

# Image e3b_1b_sb510 {.tabset}

```{r}
rois.trail <- "_dapi.tif_rois.zip"
band.trail.1 <- "_Tal1.tif"
band.trail.2 <- "_Tead2.tif"
band.trail.3 <- "_E2f1.tif"
dapi.trail <- "_dapi.tif"
image.base <- "e3b_1b_sb510_e12.5_63x"
```

```{r Reading imageJ ROIS file for a image e3b_1b_sb510}
rois <- read.ijzip(file = paste(rois.path,image.base,rois.trail,sep=""))
rois.ss <- ij2spatstat(rois)
```

```{r Reading channels from image files e3b_1b_sb510, warning=FALSE}
ras.1 <- flip(raster(paste(fluor.channel.path,image.base,band.trail.1,sep=""), band=1), direction="x")
ras.2 <- flip(raster(paste(fluor.channel.path,image.base,band.trail.2,sep=""), band=3), direction="x")
ras.3 <- flip(raster(paste(fluor.channel.path,image.base,band.trail.3,sep=""), band=2), direction="x")
ras.dapi <- flip(raster(paste(fluor.channel.path,image.base,dapi.trail,sep=""), band=1),direction="x")

im.1 <- as.im(as.matrix(ras.1))
im.2 <- as.im(as.matrix(ras.2))
im.3 <- as.im(as.matrix(ras.3))
im.dapi <- as.im(as.matrix(ras.dapi))
```

## Segmentation and channels check

```{r Plot DAPI channel to check orientation e3b_1b_sb510}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.dapi)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```

```{r Plot channel 1 to check orientation e3b_1b_sb510}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.1)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```

```{r Plot channel 2 to check orientation e3b_1b_sb510}
plot(im.2)
plot(rois, TRUE,xlim=c(0, ras.2@extent@xmax), ylim=c(ras.2@extent@ymax, 0))
```

```{r Plot channel 3 to check orientation e3b_1b_sb510}
plot(im.3)
plot(rois, TRUE,xlim=c(0, ras.3@extent@xmax), ylim=c(ras.3@extent@ymax, 0))
```

```{r Define circle e3b_1b_sb510, eval=FALSE}
plot(im.dapi)
three.points <- locator()
saveRDS(three.points,file="../../analysis/e3b_1b_sb510.three.points.Rds")
```

```{r}
three.points <- readRDS(file="../../analysis/e3b_1b_sb510.three.points.Rds")
```

```{r Process e3b_1b_sb510}
count.per.cell.channel.filt.e3b_1b_sb510 <- process_image_data(
  rois.ss = rois.ss, 
  im.1 = im.1, 
  im.2 = im.2, 
  im.3 = im.3, 
  rois = rois, 
  three.points = three.points, 
  cores = cores, 
  replicate_name = "e3b_1b_sb510", 
  quantile_threshold = 0.25,
  cell.size.avg = global_avg_diameter
)
```

## Fluorescence from VZ

```{r}
ggplot(count.per.cell.channel.filt.e3b_1b_sb510, aes(x=cell.distances,y=count.dots)) + geom_point(aes(colour = factor(ch))) + scale_color_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","E2f1")) + labs(color="Channel") + theme_minimal() +ggtitle("Raw values") + xlab("Micrometers")
```

```{r}
plot_sliding_mean(count.per.cell.channel.filt.e3b_1b_sb510, window_size = 8)
```

## Stacked barplot of fluor dot proportions as distance from VZ

```{r fig.width=12, fig.height=4}
ggplot(count.per.cell.channel.filt.e3b_1b_sb510, aes(fill=as.character(ch), y=norm_count_dots, x=cell.distances)) + geom_bar(position="stack", width = 1,stat="identity") + scale_fill_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","E2f1")) + theme_minimal()  + theme(axis.text.x = element_blank()) + labs(fill="Channel") + xlab("Cells in increasing distance from VZ (as units of average cell size)")
```

# e3b aggregated

```{r, fig.width=10}
# Combine replicates first
combined_replicates <- rbind(count.per.cell.channel.filt.e3b_1b_sb514, 
                             count.per.cell.channel.filt.e3b_3b_sb509, 
                             count.per.cell.channel.filt.e3b_1b_sb510)

combined_replicates <- filter_by_max_distance(combined_replicates)

plot_sliding_mean_replicates(combined_replicates, window_size = 8)
```

```{r}
# Normalize within each channel for each replicate
slided.tb <- combined_replicates %>%
  group_by(replicate, ch) %>%
  mutate(count.dots_norm = (count.dots - mean(count.dots)) / sd(count.dots)) %>%
  ungroup()

# Apply symmetrical sliding window to count.dots_norm
slided.tb <- apply_sliding_window(slided.tb, window_size = 8)

# 2. Remove any remaining NAs after the sliding window process
slided.tb <- na.omit(slided.tb)

# Convert replicate to a factor if it's not already
slided.tb$replicate <- as.factor(slided.tb$replicate)

# Fit the updated GAMM model with replicate and channel
gam_model_both_updated <- gam(count.dots_norm_slid ~ replicate + ch + 
                              s(cell.distances, bs = "cr") +         # Overall smooth term for distance
                              s(cell.distances, by = replicate, bs = "cr") +   # Smooth term per replicate
                              s(cell.distances, by = ch, bs = "cr"),           # Smooth term per channel
                              data = slided.tb, method = "REML")

# Check the summary of the model
summary(gam_model_both_updated)
```

```{r}
# Extract parametric coefficients from the model summary
parametric_coefficients <- summary(gam_model_both_updated)$p.table

# Convert parametric coefficients to a tibble
parametric_tibble <- tibble::tibble(
  term = rownames(parametric_coefficients),
  estimate = parametric_coefficients[, 1],
  std.error = parametric_coefficients[, 2],
  statistic = parametric_coefficients[, 3],
  p.value = parametric_coefficients[, 4]
)

# Extract smooth terms from the model summary
smooth_terms <- summary(gam_model_both_updated)$s.table

# Convert smooth terms to a tibble
smooth_tibble <- tibble::tibble(
  term = rownames(smooth_terms),
  edf = smooth_terms[, 1],
  ref_df = smooth_terms[, 2],
  F_stat = smooth_terms[, 3],
  p_value = smooth_terms[, 4]
)

# Combine parametric and smooth terms into a neat tibble list
results_tibble <- list(
  "Parametric Coefficients" = parametric_tibble,
  "Smooth Terms" = smooth_tibble
)

# Display the results as two tibbles
results_tibble
```

# Image e4_1c_sb514 {.tabset}

```{r}
rois.trail <- "_dapi.tif_rois.zip"
band.trail.1 <- "_Tal1.tif"
band.trail.2 <- "_Tead2.tif"
band.trail.3 <- "_Ebf1.tif"
dapi.trail <- "_dapi.tif"
image.base <- "e4_1c_sb514_e12.5_63x"
```

```{r Reading imageJ ROIS file for a image e4_1c_sb514}
rois <- read.ijzip(file = paste(rois.path,image.base,rois.trail,sep=""))
rois.ss <- ij2spatstat(rois)
```

```{r Reading channels from image files e4_1c_sb514, warning=FALSE}
ras.1 <- raster(paste(fluor.channel.path,image.base,band.trail.1,sep=""), band=1)
ras.2 <- raster(paste(fluor.channel.path,image.base,band.trail.2,sep=""), band=3)
ras.3 <- raster(paste(fluor.channel.path,image.base,band.trail.3,sep=""), band=2)
ras.dapi <- raster(paste(fluor.channel.path,image.base,dapi.trail,sep=""), band=1)

im.1 <- as.im(as.matrix(ras.1))
im.2 <- as.im(as.matrix(ras.2))
im.3 <- as.im(as.matrix(ras.3))
im.dapi <- as.im(as.matrix(ras.dapi))
```

## Segmentation and channels check

```{r Plot DAPI channel to check orientation e4_1c_sb514}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.dapi)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```


```{r Plot channel 1 to check orientation e4_1c_sb514}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.1)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```

```{r Plot channel 2 to check orientation e4_1c_sb514}
plot(im.2)
plot(rois, TRUE,xlim=c(0, ras.2@extent@xmax), ylim=c(ras.2@extent@ymax, 0))
```

```{r Plot channel 3 to check orientation e4_1c_sb514}
plot(im.3)
plot(rois, TRUE,xlim=c(0, ras.3@extent@xmax), ylim=c(ras.3@extent@ymax, 0))
```

```{r Define circle e4_1c_sb514, eval=FALSE}
plot(im.dapi)
three.points <- locator()
saveRDS(three.points,file="../../analysis/e4_1c_sb514.three.points.Rds")
```

```{r}
three.points <- readRDS(file="../../analysis/e4_1c_sb514.three.points.Rds")
```

```{r Process e4_1c_sb514}
count.per.cell.channel.filt.e4_1c_sb514 <- process_image_data(
  rois.ss = rois.ss, 
  im.1 = im.1, 
  im.2 = im.2, 
  im.3 = im.3, 
  rois = rois, 
  three.points = three.points, 
  cores = cores, 
  replicate_name = "e4_1c_sb514", 
  quantile_threshold = 0.25,
  cell.size.avg = global_avg_diameter
)
```

## Fluorescence from VZ

```{r}
ggplot(count.per.cell.channel.filt.e4_1c_sb514, aes(x=cell.distances,y=count.dots)) + geom_point(aes(colour = factor(ch))) + scale_color_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","Ebf1")) + labs(color="Channel") + theme_minimal() +ggtitle("Raw values") + xlab("Micrometers")
```

```{r}
plot_sliding_mean(count.per.cell.channel.filt.e4_1c_sb514,window_size = 8)
```

## Stacked barplot of fluor dot proportions as distance from VZ

```{r fig.width=12, fig.height=4}
ggplot(count.per.cell.channel.filt.e4_1c_sb514, aes(fill=as.character(ch), y=norm_count_dots, x=cell.distances)) + geom_bar(position="stack", width = 1,stat="identity") + scale_fill_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","Ebf1")) + theme_minimal()  + theme(axis.text.x = element_blank()) + labs(fill="Channel") + xlab("Cells in increasing distance from VZ (as units of average cell size)")
```

<!-- # Image e4_3e_sb509 {.tabset} -->

<!-- ```{r} -->
<!-- rois.trail <- "_dapi.tif_rois.zip" -->
<!-- band.trail.1 <- "_Tal1.tif" -->
<!-- band.trail.2 <- "_Tead2.tif" -->
<!-- band.trail.3 <- "_Ebf1.tif" -->
<!-- dapi.trail <- "_dapi.tif" -->
<!-- image.base <- "e4_3e_sb509_e12.5_63x" -->
<!-- ``` -->

<!-- ```{r Reading imageJ ROIS file for a image e4_3e_sb509} -->
<!-- rois <- read.ijzip(file = paste(rois.path,image.base,rois.trail,sep="")) -->
<!-- rois.ss <- ij2spatstat(rois) -->
<!-- ``` -->

<!-- ```{r Reading channels from image files e4_3e_sb509, warning=FALSE} -->
<!-- ras.1 <- raster(paste(fluor.channel.path,image.base,band.trail.1,sep=""), band=1) -->
<!-- ras.2 <- raster(paste(fluor.channel.path,image.base,band.trail.2,sep=""), band=3) -->
<!-- ras.3 <- raster(paste(fluor.channel.path,image.base,band.trail.3,sep=""), band=2) -->
<!-- ras.dapi <- raster(paste(fluor.channel.path,image.base,dapi.trail,sep=""), band=1) -->

<!-- im.1 <- as.im(as.matrix(ras.1)) -->
<!-- im.2 <- as.im(as.matrix(ras.2)) -->
<!-- im.3 <- as.im(as.matrix(ras.3)) -->
<!-- im.dapi <- as.im(as.matrix(ras.dapi)) -->
<!-- ``` -->

<!-- ## Segmentation and channels check -->

<!-- ```{r Plot DAPI channel to check orientation e4_3e_sb509} -->
<!-- #plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0)) -->
<!-- plot(im.dapi) -->
<!-- plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0)) -->
<!-- ``` -->

<!-- ```{r Plot channel 1 to check orientation e4_3e_sb509} -->
<!-- #plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0)) -->
<!-- plot(im.1) -->
<!-- plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0)) -->
<!-- ``` -->

<!-- ```{r Plot channel 2 to check orientation e4_3e_sb509} -->
<!-- plot(im.2) -->
<!-- plot(rois, TRUE,xlim=c(0, ras.2@extent@xmax), ylim=c(ras.2@extent@ymax, 0)) -->
<!-- ``` -->

<!-- ```{r Plot channel 3 to check orientation e4_3e_sb509} -->
<!-- plot(im.3) -->
<!-- plot(rois, TRUE,xlim=c(0, ras.3@extent@xmax), ylim=c(ras.3@extent@ymax, 0)) -->
<!-- ``` -->

<!-- ## Aggregate signal per cell and radial distance -->

<!-- ```{r Define circle e4_3e_sb509, eval=FALSE} -->
<!-- plot(im.dapi) -->
<!-- three.points <- locator() -->
<!-- saveRDS(three.points,file="../../analysis/e4_3e_sb509.three.points.Rds") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- three.points <- readRDS(file="../../analysis/e4_3e_sb509.three.points.Rds") -->
<!-- ``` -->

<!-- ```{r Process e4_3e_sb509} -->
<!-- count.per.cell.channel.filt.e4_3e_sb509 <- process_image_data( -->
<!--   rois.ss = rois.ss,  -->
<!--   im.1 = im.1,  -->
<!--   im.2 = im.2,  -->
<!--   im.3 = im.3,  -->
<!--   rois = rois,  -->
<!--   three.points = three.points,  -->
<!--   cores = cores,  -->
<!--   replicate_name = "e4_3e_sb509",  -->
<!--   quantile_threshold = 0.25 -->
<!-- ) -->
<!-- ``` -->

<!-- ## Fluorescence from VZ -->

<!-- ```{r} -->
<!-- ggplot(count.per.cell.channel.filt.e4_3e_sb509, aes(x=cell.distances,y=count.dots)) + geom_point(aes(colour = factor(ch))) + scale_color_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","Ebf1")) + labs(color="Channel") + theme_minimal() +ggtitle("Raw values") + xlab("Micrometers") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- plot_sliding_mean(count.per.cell.channel.filt.e4_3e_sb509,window_size = 8) -->
<!-- ``` -->

<!-- ## Stacked barplot of fluor dot proportions as distance from VZ -->

<!-- ```{r fig.width=12, fig.height=4} -->
<!-- ggplot(count.per.cell.channel.filt.e4_3e_sb509, aes(fill=as.character(ch), y=norm_count_dots, x=cell.i)) + geom_bar(position="stack", width = 1,stat="identity") + scale_fill_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","Ebf1")) + theme_minimal()  + theme(axis.text.x = element_blank()) + labs(fill="Channel") + xlab("Cells in increasing distance from VZ (as units of average cell size)") -->
<!-- ``` -->

<!-- <!-- # Image e4_1c_sb510 {.tabset} --> -->

<!-- <!-- ```{r} --> -->
<!-- <!-- rois.trail <- "_dapi.tif_rois.zip" --> -->
<!-- <!-- band.trail.1 <- "_Tal1.tif" --> -->
<!-- <!-- band.trail.2 <- "_Tead2.tif" --> -->
<!-- <!-- band.trail.3 <- "_Ebf1.tif" --> -->
<!-- <!-- dapi.trail <- "_dapi.tif" --> -->
<!-- <!-- image.base <- "e4_1c_sb510_e12.5_63x" --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ```{r Reading imageJ ROIS file for a image e4_1c_sb510} --> -->
<!-- <!-- rois <- read.ijzip(file = paste(rois.path,image.base,rois.trail,sep="")) --> -->
<!-- <!-- rois.ss <- ij2spatstat(rois) --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ```{r Reading channels from image files e4_1c_sb510, warning=FALSE} --> -->
<!-- <!-- ras.1 <- flip(raster(paste(fluor.channel.path,image.base,band.trail.1,sep=""), band=1), direction="y") --> -->
<!-- <!-- ras.2 <- flip(raster(paste(fluor.channel.path,image.base,band.trail.2,sep=""), band=3), direction="y") --> -->
<!-- <!-- ras.3 <- flip(raster(paste(fluor.channel.path,image.base,band.trail.3,sep=""), band=2), direction="y") --> -->
<!-- <!-- ras.dapi <- flip(raster(paste(fluor.channel.path,image.base,dapi.trail,sep=""), band=1),direction="y") --> -->

<!-- <!-- im.1 <- as.im(as.matrix(ras.1)) --> -->
<!-- <!-- im.2 <- as.im(as.matrix(ras.2)) --> -->
<!-- <!-- im.3 <- as.im(as.matrix(ras.3)) --> -->
<!-- <!-- im.dapi <- as.im(as.matrix(ras.dapi)) --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ## Segmentation and channels check --> -->

<!-- <!-- ```{r Plot DAPI channel to check orientation e4_1c_sb510} --> -->
<!-- <!-- #plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0)) --> -->
<!-- <!-- plot(im.dapi) --> -->
<!-- <!-- plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0)) --> -->
<!-- <!-- ``` --> -->


<!-- <!-- ```{r Plot channel 1 to check orientation e4_1c_sb510} --> -->
<!-- <!-- #plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0)) --> -->
<!-- <!-- plot(im.1) --> -->
<!-- <!-- plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0)) --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ```{r Plot channel 2 to check orientation e4_1c_sb510} --> -->
<!-- <!-- plot(im.2) --> -->
<!-- <!-- plot(rois, TRUE,xlim=c(0, ras.2@extent@xmax), ylim=c(ras.2@extent@ymax, 0)) --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ```{r Plot channel 3 to check orientation e4_1c_sb510} --> -->
<!-- <!-- plot(im.3) --> -->
<!-- <!-- plot(rois, TRUE,xlim=c(0, ras.3@extent@xmax), ylim=c(ras.3@extent@ymax, 0)) --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ## Aggregate signal per cell and radial distance --> -->

<!-- <!-- ```{r Define circle e4_1c_sb510, eval=FALSE} --> -->
<!-- <!-- plot(im.dapi) --> -->
<!-- <!-- three.points <- locator() --> -->
<!-- <!-- saveRDS(three.points,file="../../analysis/e4_1c_sb510.three.points.Rds") --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ```{r} --> -->
<!-- <!-- three.points <- readRDS(file="../../analysis/e4_1c_sb510.three.points.Rds") --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ```{r Process e4_1c_sb510} --> -->
<!-- <!-- count.per.cell.channel.filt.e4_1c_sb510 <- process_image_data( --> -->
<!-- <!--   rois.ss = rois.ss,  --> -->
<!-- <!--   im.1 = im.1,  --> -->
<!-- <!--   im.2 = im.2,  --> -->
<!-- <!--   im.3 = im.3,  --> -->
<!-- <!--   rois = rois,  --> -->
<!-- <!--   three.points = three.points,  --> -->
<!-- <!--   cores = cores,  --> -->
<!-- <!--   replicate_name = "e4_1c_sb510",  --> -->
<!-- <!--   quantile_threshold = 0.25 --> -->
<!-- <!-- ) --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ## Fluorescence from VZ --> -->

<!-- <!-- ```{r} --> -->
<!-- <!-- ggplot(count.per.cell.channel.filt.e4_1c_sb510, aes(x=cell.distances,y=count.dots)) + geom_point(aes(colour = factor(ch))) + scale_color_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","Ebf1")) + labs(color="Channel") + theme_minimal() +ggtitle("Raw values") + xlab("Micrometers") --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ```{r} --> -->
<!-- <!-- plot_sliding_mean(count.per.cell.channel.filt.e4_1c_sb510,window_size = 8) --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ## Stacked barplot of fluor dot proportions as distance from VZ --> -->

<!-- <!-- ```{r fig.width=12, fig.height=4} --> -->
<!-- <!-- ggplot(count.per.cell.channel.filt.e4_1c_sb510, aes(fill=as.character(ch), y=norm_count_dots, x=cell.i)) + geom_bar(position="stack", width = 1,stat="identity") + scale_fill_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","Ebf1")) + theme_minimal()  + theme(axis.text.x = element_blank()) + labs(fill="Channel") + xlab("Cells in increasing distance from VZ (as units of average cell size)") + xlab("Micrometers") --> -->
<!-- <!-- ``` --> -->


# Image e4_2b_sb0488 {.tabset}

```{r}
rois.trail <- "_dapi.tif_rois.zip"
band.trail.1 <- "_Tal1.tif"
band.trail.2 <- "_Tead2.tif"
band.trail.3 <- "_Ebf1.tif"
dapi.trail <- "_dapi.tif"
image.base <- "e4_2b_sb0488_e12.5_63x"
```

```{r Reading imageJ ROIS file for a image e4_2b_sb0488}
rois <- read.ijzip(file = paste(rois.path,image.base,rois.trail,sep=""))
rois.ss <- ij2spatstat(rois)
```

```{r Reading channels from image files e4_2b_sb0488, warning=FALSE}
ras.1 <- raster(paste(fluor.channel.path,image.base,band.trail.1,sep=""), band=1)
ras.2 <- raster(paste(fluor.channel.path,image.base,band.trail.2,sep=""), band=1)
ras.3 <- raster(paste(fluor.channel.path,image.base,band.trail.3,sep=""), band=1)
ras.dapi <- raster(paste(fluor.channel.path,image.base,dapi.trail,sep=""), band=1)

im.1 <- as.im(as.matrix(ras.1))
im.2 <- as.im(as.matrix(ras.2))
im.3 <- as.im(as.matrix(ras.3))
im.dapi <- as.im(as.matrix(ras.dapi))
```

## Segmentation and channels check

```{r Plot DAPI channel to check orientation e4_2b_sb0488}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.dapi)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```


```{r Plot channel 1 to check orientation e4_2b_sb0488}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.1)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```

```{r Plot channel 2 to check orientation e4_2b_sb0488}
plot(im.2)
plot(rois, TRUE,xlim=c(0, ras.2@extent@xmax), ylim=c(ras.2@extent@ymax, 0))
```

```{r Plot channel 3 to check orientation e4_2b_sb0488}
plot(im.3)
plot(rois, TRUE,xlim=c(0, ras.3@extent@xmax), ylim=c(ras.3@extent@ymax, 0))
```

## Aggregate signal per cell and radial distance

```{r Define circle e4_2b_sb0488, eval=FALSE}
plot(im.dapi)
three.points <- locator()
saveRDS(three.points,file="../../analysis/e4_2b_sb0488.three.points.Rds")
```

```{r}
three.points <- readRDS(file="../../analysis/e4_2b_sb0488.three.points.Rds")
```

```{r Process e4_2b_sb0488}
count.per.cell.channel.filt.e4_2b_sb0488 <- process_image_data(
  rois.ss = rois.ss, 
  im.1 = im.1, 
  im.2 = im.2, 
  im.3 = im.3, 
  rois = rois, 
  three.points = three.points, 
  cores = cores, 
  replicate_name = "e4_2b_sb0488", 
  quantile_threshold = 0.25,
  cell.size.avg = global_avg_diameter
)
```

## Fluorescence from VZ

```{r}
ggplot(count.per.cell.channel.filt.e4_2b_sb0488, aes(x=cell.distances,y=count.dots)) + geom_point(aes(colour = factor(ch))) + scale_color_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","Ebf1")) + labs(color="Channel") + theme_minimal() +ggtitle("Raw values") + xlab("Micrometers")
```

```{r}
plot_sliding_mean(count.per.cell.channel.filt.e4_2b_sb0488,window_size = 8)
```

## Stacked barplot of fluor dot proportions as distance from VZ

```{r fig.width=12, fig.height=4}
ggplot(count.per.cell.channel.filt.e4_2b_sb0488, aes(fill=as.character(ch), y=norm_count_dots, x=cell.distances)) + geom_bar(position="stack", width = 1,stat="identity") + scale_fill_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","Ebf1")) + theme_minimal()  + theme(axis.text.x = element_blank()) + labs(fill="Channel") + xlab("Cells in increasing distance from VZ (as units of average cell size)") + xlab("Micrometers")
```


# Image e4_4c_sb0479 {.tabset}

```{r}
rois.trail <- "_dapi.tif_rois.zip"
band.trail.1 <- "_Tal1.tif"
band.trail.2 <- "_Tead2.tif"
band.trail.3 <- "_Ebf1.tif"
dapi.trail <- "_dapi.tif"
image.base <- "e4_4c_sb0479_e12.5_63x"
```

```{r Reading imageJ ROIS file for a image e4_4c_sb0479}
rois <- read.ijzip(file = paste(rois.path,image.base,rois.trail,sep=""))
rois.ss <- ij2spatstat(rois)
```

```{r Reading channels from image files e4_4c_sb0479, warning=FALSE}
ras.1 <- raster(paste(fluor.channel.path,image.base,band.trail.1,sep=""), band=1)
ras.2 <- raster(paste(fluor.channel.path,image.base,band.trail.2,sep=""), band=1)
ras.3 <- raster(paste(fluor.channel.path,image.base,band.trail.3,sep=""), band=1)
ras.dapi <- raster(paste(fluor.channel.path,image.base,dapi.trail,sep=""), band=1)

im.1 <- as.im(as.matrix(ras.1))
im.2 <- as.im(as.matrix(ras.2))
im.3 <- as.im(as.matrix(ras.3))
im.dapi <- as.im(as.matrix(ras.dapi))
```

## Segmentation and channels check

```{r Plot DAPI channel to check orientation e4_4c_sb0479}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.dapi)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```


```{r Plot channel 1 to check orientation e4_4c_sb0479}
#plot(NA,NA,asp=1, xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
plot(im.1)
plot(rois, TRUE,xlim=c(0, ras.1@extent@xmax), ylim=c(ras.1@extent@ymax, 0))
```

```{r Plot channel 2 to check orientation e4_4c_sb0479}
plot(im.2)
plot(rois, TRUE,xlim=c(0, ras.2@extent@xmax), ylim=c(ras.2@extent@ymax, 0))
```

```{r Plot channel 3 to check orientation e4_4c_sb0479}
plot(im.3)
plot(rois, TRUE,xlim=c(0, ras.3@extent@xmax), ylim=c(ras.3@extent@ymax, 0))
```

## Aggregate signal per cell and radial distance

```{r Define circle e4_4c_sb0479, eval=FALSE}
plot(im.dapi)
three.points <- locator()
saveRDS(three.points,file="../../analysis/e4_4c_sb0479.three.points.Rds")
```

```{r}
three.points <- readRDS(file="../../analysis/e4_4c_sb0479.three.points.Rds")
```

```{r Process e4_4c_sb0479}
count.per.cell.channel.filt.e4_4c_sb0479 <- process_image_data(
  rois.ss = rois.ss, 
  im.1 = im.1, 
  im.2 = im.2, 
  im.3 = im.3, 
  rois = rois, 
  three.points = three.points, 
  cores = cores, 
  replicate_name = "e4_4c_sb0479", 
  quantile_threshold = 0.25,
  cell.size.avg = global_avg_diameter
)
```

## Fluorescence from VZ

```{r}
ggplot(count.per.cell.channel.filt.e4_4c_sb0479, aes(x=cell.distances,y=count.dots)) + geom_point(aes(colour = factor(ch))) + scale_color_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","Ebf1")) + labs(color="Channel") + theme_minimal() +ggtitle("Raw values") + xlab("Micrometers")
```

```{r}
plot_sliding_mean(count.per.cell.channel.filt.e4_4c_sb0479,window_size = 8)
```

## Stacked barplot of fluor dot proportions as distance from VZ

```{r fig.width=12, fig.height=4}
ggplot(count.per.cell.channel.filt.e4_4c_sb0479, aes(fill=as.character(ch), y=norm_count_dots, x=cell.distances)) + geom_bar(position="stack", width = 1,stat="identity") + scale_fill_manual(values=c("magenta2", "dodgerblue", "forestgreen"),labels=c("Tal1","Tead2","Ebf1")) + theme_minimal()  + theme(axis.text.x = element_blank()) + labs(fill="Channel") + xlab("Cells in increasing distance from VZ (as units of average cell size)") + xlab("Micrometers")
```

# e4 aggregated

```{r, fig.width=10}
# Combine replicates first
combined_replicates <- rbind(count.per.cell.channel.filt.e4_4c_sb0479, 
                             count.per.cell.channel.filt.e4_2b_sb0488, 
                             count.per.cell.channel.filt.e4_1c_sb514)

combined_replicates <- filter_by_max_distance(combined_replicates)

plot_sliding_mean_replicates(combined_replicates, window_size = 8)
```

```{r}
# Normalize within each channel for each replicate
slided.tb <- combined_replicates %>%
  group_by(replicate, ch) %>%
  mutate(count.dots_norm = (count.dots - mean(count.dots)) / sd(count.dots)) %>%
  ungroup()

# Apply symmetrical sliding window to count.dots_norm
slided.tb <- apply_sliding_window(slided.tb, window_size = 8)

# 2. Remove any remaining NAs after the sliding window process
slided.tb <- na.omit(slided.tb)

# Convert replicate to a factor if it's not already
slided.tb$replicate <- as.factor(slided.tb$replicate)

# Fit the updated GAMM model with replicate and channel
gam_model_both_updated <- gam(count.dots_norm_slid ~ replicate + ch + 
                              s(cell.distances, bs = "cr") +         # Overall smooth term for distance
                              s(cell.distances, by = replicate, bs = "cr") +   # Smooth term per replicate
                              s(cell.distances, by = ch, bs = "cr"),           # Smooth term per channel
                              data = slided.tb, method = "REML")

# Check the summary of the model
summary(gam_model_both_updated)
```

```{r}
# Extract parametric coefficients from the model summary
parametric_coefficients <- summary(gam_model_both_updated)$p.table

# Convert parametric coefficients to a tibble
parametric_tibble <- tibble::tibble(
  term = rownames(parametric_coefficients),
  estimate = parametric_coefficients[, 1],
  std.error = parametric_coefficients[, 2],
  statistic = parametric_coefficients[, 3],
  p.value = parametric_coefficients[, 4]
)

# Extract smooth terms from the model summary
smooth_terms <- summary(gam_model_both_updated)$s.table

# Convert smooth terms to a tibble
smooth_tibble <- tibble::tibble(
  term = rownames(smooth_terms),
  edf = smooth_terms[, 1],
  ref_df = smooth_terms[, 2],
  F_stat = smooth_terms[, 3],
  p_value = smooth_terms[, 4]
)

# Combine parametric and smooth terms into a neat tibble list
results_tibble <- list(
  "Parametric Coefficients" = parametric_tibble,
  "Smooth Terms" = smooth_tibble
)

# Display the results as two tibbles
results_tibble
```