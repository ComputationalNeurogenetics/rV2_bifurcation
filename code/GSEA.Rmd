---
title: "R Notebook for testing GSEA calculations for target genes"
output: html_document
---

```{r}
library(tidyverse)
library(Seurat)
library(Signac)
library(qs)
library(readxl)
library(hash)
library(fgsea)
library(DBI)
library(hash)
```

```{r}
cores <- 8
con <- DBI::dbConnect(RSQLite::SQLite(), dbname = "../../TOBIAS.dr.h12_130324.sqlite")
```


```{r}
plot_loc <- "~/OneDrive - University of Helsinki/E12R1 project/Manuscript I - Regulation of Tal1 dependent rV2 lineage bifurcation/Figures/plots/training/"

rV2.dataset <- qread("../scATAC_data/nmm_rV2_subset_relabeled_031023_links.qs", nthreads = cores)

rV2.dataset$rv2.lineage_re <- case_when(
  rV2.dataset$rv2.lineage %in% "PRO1" ~ "PRO1_2",
  rV2.dataset$rv2.lineage %in% "PRO2" ~ "PRO1_2",
  rV2.dataset$rv2.lineage %in% "GA1" ~ "GA1_2",
  rV2.dataset$rv2.lineage %in% "GA2" ~ "GA1_2",
  rV2.dataset$rv2.lineage %in% "GA3" ~ "GA3_4",
  rV2.dataset$rv2.lineage %in% "GA4" ~ "GA3_4",
  rV2.dataset$rv2.lineage %in% "GA5" ~ "GA5_6",
  rV2.dataset$rv2.lineage %in% "GA6" ~ "GA5_6",
  rV2.dataset$rv2.lineage %in% "CO1" ~ "CO1_2",
  rV2.dataset$rv2.lineage %in% "CO2" ~ "CO1_2",
  rV2.dataset$rv2.lineage %in% "GL1" ~ "GL1_2",
  rV2.dataset$rv2.lineage %in% "GL2" ~ "GL1_2",
  rV2.dataset$rv2.lineage %in% "GL3" ~ "GL3_4",
  rV2.dataset$rv2.lineage %in% "GL4" ~ "GL3_4",
  rV2.dataset$rv2.lineage %in% "GL5" ~ "GL5",
)


serot.dataset <- qread("../serot/sero_relabeled_201123_links.qs", nthreads = cores)
```

```{r}
merged.datasets <- merge(rV2.dataset,serot.dataset)

# merged.datasets$merged.groups <- factor(ifelse(is.na(merged.datasets$sero.lineage), merged.datasets$rv2.lineage, merged.datasets$sero.lineage), levels=c("PRO1","PRO2","CO1","CO2","GA1","GA2","GA3","GA4","GA5","GA6","GL1","GL2","GL3","GL4","GL5","SR1","SR2","SR3"))

merged.datasets$merged.groups <- factor(ifelse(is.na(merged.datasets$sero.lineage), merged.datasets$rv2.lineage_re, merged.datasets$sero.lineage), levels=c("PRO1_2","CO1_2","GA1_2","GA3_4","GA5_6","GL1_2","GL3_4","GL5","SR1","SR2","SR3"))

gene_name_hash <- hash(rownames(rV2.dataset[['RNA']][[]]),rV2.dataset[['RNA']][[]][,1])

DefaultAssay(merged.datasets) <- "RNA"
```


```{r}
assay.averages <- AverageExpression(merged.datasets,group.by = "merged.groups")

```

```{r}
#min.filter <- (assay.averages$RNA[,"GA1_2"]>0.1 | assay.averages$RNA[,"GA1_2"]==0) & (assay.averages$RNA[,"GL1_2"]>0.1 | assay.averages$RNA[,"GL1_2"]==0)
log2.GA1_GL1 <- log2(assay.averages$RNA[,"GA1_2"]/assay.averages$RNA[,"GL1_2"])
log2.GA1_GL1 <- sort(log2.GA1_GL1[is.finite(log2.GA1_GL1)])

Idents(merged.datasets) <- merged.datasets$rv2.lineage_re
DEG.res <- FindMarkers(merged.datasets, ident.1="GA1_2", ident.2 = "GL1_2") %>% rownames_to_column(var="ensg_id") %>% as_tibble()

DEG.res.final <- filter(DEG.res, p_val_adj<0.01) %>%  pull(avg_log2FC)
names(DEG.res.final) <- filter(DEG.res, p_val_adj<0.01) %>% pull(ensg_id)

TF_name<-"Tal1"
targetQuery <- paste("SELECT li.ensg_id FROM links as li, tobias as tb, CT_data as ct WHERE tb.features=li.feature AND tb.TF_gene_name='",toupper(TF_name),"' AND li.zscore>2 AND li.pvalue<0.001 AND ct.target_gene_name='",TF_name,"' AND ct.feature=tb.features AND tb.TFBS_name='TAL1.H12CORE.0.P.B_TAL1.H12CORE.0.P.B' AND tb.mean_cons>0.5;",sep="")
targets.Tal1 <- as_tibble(dbGetQuery(con, targetQuery)) %>% distinct()
plotEnrichment(targets.Tal1$ensg_id, DEG.res.final) + ggtitle(paste(TF_name,"target enrichments in GA/GL DEG"))

TF_name<-"Gata2"
targetQuery <- paste("SELECT li.ensg_id FROM links as li, tobias as tb, CT_data as ct WHERE tb.features=li.feature AND tb.TF_gene_name='",toupper(TF_name),"' AND li.zscore>2 AND li.pvalue<0.001 AND ct.target_gene_name='",TF_name,"' AND ct.feature=tb.features AND tb.mean_cons>0.5;",sep="") 
targets.Gata2 <- as_tibble(dbGetQuery(con, targetQuery)) %>% distinct()
plotEnrichment(targets.Gata2$ensg_id, DEG.res.final) + ggtitle(paste(TF_name,"target enrichments in GA/GL DEG"))

TF_name<-"Gata3"
targetQuery <- paste("SELECT li.ensg_id FROM links as li, tobias as tb, CT_data as ct WHERE tb.features=li.feature AND tb.TF_gene_name='",toupper(TF_name),"' AND li.zscore>2 AND li.pvalue<0.001 AND ct.target_gene_name='",TF_name,"' AND ct.feature=tb.features AND tb.mean_cons>0.5;",sep="") 
targets.Gata3 <- as_tibble(dbGetQuery(con, targetQuery)) %>% distinct()
plotEnrichment(targets.Gata3$ensg_id, DEG.res.final) + ggtitle(paste(TF_name,"target enrichments in GA/GL DEG"))

TF_name<-"Vsx2"
targetQuery <- paste("SELECT li.ensg_id FROM links as li, tobias as tb, CT_data as ct WHERE tb.features=li.feature AND tb.TF_gene_name='",toupper(TF_name),"' AND li.zscore>2 AND li.pvalue<0.001 AND ct.target_gene_name='",TF_name,"' AND ct.feature=tb.features AND tb.mean_cons>0.5;",sep="")
targets.Vsx2 <- as_tibble(dbGetQuery(con, targetQuery)) %>% distinct()
plotEnrichment(targets.Vsx2$ensg_id, DEG.res.final) + ggtitle(paste(TF_name,"target enrichments in GA/GL DEG"))

TF_name<-"Sox4"
targetQuery <- paste("SELECT li.ensg_id FROM links as li, tobias as tb, CT_data as ct WHERE tb.features=li.feature AND tb.TF_gene_name='",toupper(TF_name),"' AND li.zscore>2 AND li.pvalue<0.001 AND ct.target_gene_name='",TF_name,"' AND ct.feature=tb.features AND tb.mean_cons>0.5;",sep="") 
targets.Sox4 <- as_tibble(dbGetQuery(con, targetQuery)) %>% distinct()
plotEnrichment(targets.Sox4$ensg_id, DEG.res.final) + ggtitle(paste(TF_name,"target enrichments in GA/GL DEG"))

geneSets <- list(targets.Tal1=targets.Tal1$ensg_id, targets.Gata2=targets.Gata2$ensg_id, targets.Gata3=targets.Gata3$ensg_id,targets.Sox4=targets.Sox4$ensg_id, targets.Vsx2=targets.Vsx2$ensg_id, GABA.genes=GABA.genes, GLU.genes=GLUT.genes)

results <- fgsea(pathways = geneSets, 
                 stats = DEG.res.final, 
                 minSize = 6,  # Minimum size of a gene set to be considered
                 maxSize = 5000) # Maximum size of a gene set to be considered
print(results)
#create_dt(results)
```

```{r}
TF_name<-"Tal1"
targetQuery <- paste("SELECT gm.gene_name FROM links as li, tobias as tb, CT_data as ct, gene_metadata as gm WHERE gm.ensg_id=li.ensg_id AND tb.features=li.feature AND tb.TF_gene_name='",toupper(TF_name),"' AND li.zscore>2 AND tb.GA1_2_bound=1 AND GL1_2_bound=0 AND li.pvalue<0.001 AND ct.target_gene_name='",TF_name,"' AND ct.feature=tb.features AND tb.TFBS_name='TAL1.H12CORE.0.P.B_TAL1.H12CORE.0.P.B' AND tb.mean_cons>0.5;",sep="") 
targets.Tal1 <- as_tibble(dbGetQuery(con, targetQuery)) %>% distinct()


targetQuery <- paste("SELECT gm.gene_name FROM links as li, tobias as tb, gene_metadata as gm WHERE gm.ensg_id=li.ensg_id AND tb.features=li.feature AND tb.TF_gene_name='",toupper(TF_name),"' AND li.zscore>2 AND tb.GA1_2_bound=0 AND GL1_2_bound=1 AND li.pvalue<0.001 AND tb.TFBS_name='TAL1.H12CORE.0.P.B_TAL1.H12CORE.0.P.B';",sep="") 
targets.Tal1 <- as_tibble(dbGetQuery(con, targetQuery)) %>% distinct()
```


```{r}
TF_name<-"Vsx2"
log2.GA1_GL1 <- log2(assay.averages$RNA[,"GA1"]/assay.averages$RNA[,"GL1"])
log2.GA1_GL1 <- sort(log2.GA1_GL1[is.finite(log2.GA1_GL1)])

targetQuery <- paste("SELECT li.feature FROM links as li, tobias as tb, CT_data as ct WHERE tb.features=li.feature AND tb.TF_gene_name='",toupper(TF_name),"' AND li.zscore>1.5 AND tb.GL1_2_bound=0 AND tb.GA1_2_bound=1 AND li.pvalue<0.001 AND ct.target_gene_name='",TF_name,"' AND ct.feature=tb.features;",sep="") 
targets.1 <- as_tibble(dbGetQuery(con, targetQuery)) %>% distinct()

geneSets <- list(Vsxset1=targets.1$ensg_id, GABA.genes=GABA.genes,GLU.genes=GLUT.genes)

results_Vsx2 <- fgsea(pathways = geneSets, 
                 stats = log2.GA1_GL1, 
                 minSize = 6,  # Minimum size of a gene set to be considered
                 maxSize = 5000) # Maximum size of a gene set to be considered

```


```{r}
gene_groups <- read_excel("../ExpressionNeuralnet/data/GeneGroupExample.xlsx")
gene_groups_long <- pivot_longer(gene_groups, cols = everything(), names_to = "Group", values_to = "feature")
```

```{r}
for (gr in unique(gene_groups_long$Group)){
  ensg.ids <- filter(gene_groups_long, Group==gr) %>% pull(feature)
  pdf(file=paste(plot_loc,paste(gr,"_violinplots.pdf",sep=""),sep=""), width = 15, height = 12, onefile=TRUE)
  for (ensg.id in ensg.ids){
    tryCatch(
      {plot.to.plot <- VlnPlot(merged.datasets, ensg.id, group.by = "merged.groups") + ggtitle(paste(ensg.id,gene_name_hash[[ensg.id]],sep=" - "))
      print(plot.to.plot)
      }
     , error=function(cond) {
       paste(ensg.id,"not found",sep=" ")
       }
    )
  }
  dev.off()
}
```

