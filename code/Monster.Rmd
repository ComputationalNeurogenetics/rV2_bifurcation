---
title: "R Notebook"
output: html_notebook
---

```{r}
library(netZooR)
library(qs)
library(Seurat)
library(Signac)
library(GenomicRanges)
library(tidyverse)
library(hash)
library(DBI)
cores<-8
```

```{r}
con <- DBI::dbConnect(RSQLite::SQLite(), dbname = "~/Workspace/TOBIAS.dr.h12_230424.sqlite")
options(timeout = 30000)
```


```{r Reading Seurat dataobject}
dataset <- qread("../scATAC_data/nmm_rV2_subset_relabeled_031023_links.qs", nthreads = cores)
DefaultAssay(dataset) <- "RNA"

dataset$rv2.lineage_re <- case_when(
  dataset$rv2.lineage %in% "PRO1" ~ "PRO1_2",
  dataset$rv2.lineage %in% "PRO2" ~ "PRO1_2",
  dataset$rv2.lineage %in% "GA1" ~ "GA1_2",
  dataset$rv2.lineage %in% "GA2" ~ "GA1_2",
  dataset$rv2.lineage %in% "GA3" ~ "GA3_4",
  dataset$rv2.lineage %in% "GA4" ~ "GA3_4",
  dataset$rv2.lineage %in% "GA5" ~ "GA5_6",
  dataset$rv2.lineage %in% "GA6" ~ "GA5_6",
  dataset$rv2.lineage %in% "CO1" ~ "CO1_2",
  dataset$rv2.lineage %in% "CO2" ~ "CO1_2",
  dataset$rv2.lineage %in% "GL1" ~ "GL1_2",
  dataset$rv2.lineage %in% "GL2" ~ "GL1_2",
  dataset$rv2.lineage %in% "GL3" ~ "GL3_4",
  dataset$rv2.lineage %in% "GL4" ~ "GL3_4",
  dataset$rv2.lineage %in% "GL5" ~ "GL5",
)

DefaultAssay(dataset) <- "peaks"
all.features <- StringToGRanges(rownames(dataset))

gene_id2name <- hash(rownames(dataset[['RNA']][[]]),dataset[['RNA']][[]][,1])
gene_name2id <- hash(dataset[['RNA']][[]][,1],rownames(dataset[['RNA']][[]]))
```

```{r Fetch data layers for graph building}
DefaultAssay(dataset) <- "RNA"
exp.data <- FetchData(object = dataset, vars = rownames(dataset))
colnames(exp.data) <- sapply(colnames(exp.data),function(id){gene_id2name[[id]]})
```

```{r Define cell groups and linked features}
lineage.li <- dataset$rv2.lineage_re %in% c("PRO1_2","CO1_2","GA1_2")

design <- dataset$rv2.lineage_re[dataset$rv2.lineage_re %in% c("PRO1_2","CO1_2","GA1_2")]

linked.features <- as_tibble(dbGetQuery(con, 'SELECT feature FROM links as li WHERE ABS(li.zscore)>2 AND li.pvalue<0.001;')) %>% pull(feature)
linked.genes <- unique(as_tibble(dbGetQuery(con, 'SELECT ensg_id FROM links as li WHERE ABS(li.zscore)>2 AND li.pvalue<0.001;')) %>% pull(ensg_id))

TF.2.gene.data <- as_tibble(dbGetQuery(con, 'SELECT tb.TF_gene_name, gm.gene_name, li.zscore FROM links as li, tobias as tb, gene_metadata as gm WHERE ABS(li.zscore)>2 AND li.pvalue<0.001 AND tb.features=li.feature AND gm.ensg_id=li.ensg_id;'))

TF.gene.data.sum <- TF.2.gene.data %>% filter (gene_name %in% colnames(exp.data)) %>% group_by(TF_gene_name, gene_name) %>% summarize(avg.score=mean(zscore))

```

```{r Subset datamatrices}
exp.lineage <- exp.data[lineage.li,]
```

```{r Run Monster}

```

```{r}
sessionInfo()
```

