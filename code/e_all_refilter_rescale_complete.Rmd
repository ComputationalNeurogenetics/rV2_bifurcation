---
title: "recreate_seurat_data"
output: html_document
---

Rerun Seurat workflow for all scRNA data sets. Main difference in parameter tuning and scaling: more unified QC parameters, using 3000 most variable features and regressing out nuisance parameters.


```{r}
.libPaths(c("/projappl/project_2001539/project_rpackages_r404", .libPaths()))
libpath <- .libPaths()[1]

library(Seurat, lib.loc = libpath)
library(tidyverse, lib.loc = libpath)
source("/scratch/project_2001539/lassi/src/Aux/convert_feature_id.R")

set.seed(42)
```

```{r}
# Run to maintain reproducibility (to some degree, see readme.md on github)
sessionInfo()
```

```{r}
# Not run on Tue 2/Wed 3 Nov run after updating to Seurat 4.0.5
options(parallelly.makeNodePSOCK.setup_strategy = "sequential", future.globals.maxSize = 12 * 1024 ^ 3, future.seed = T)
future::plan("multisession", workers = 6)
```

```{r import raw data files}
# Import E1x, x in {2,3,4,5} raw data files with gene.column = 1 = ENSEMBL ID names instead of gene symbols

e12.1f <- Read10X("/scratch/project_2001045/kaia/E12_5_WT/Batch1_030220/Batch1_030220/count_200227_A00464_0167_BHKLYLDRXX/153-1-F/outs/filtered_feature_bc_matrix/", gene.column = 1, strip.suffix = T)
e12.7f <- Read10X("/scratch/project_2001045/kaia/E12_5_WT/Batch1_030220/Batch1_030220/count_200227_A00464_0167_BHKLYLDRXX/153-7-F/outs/filtered_feature_bc_matrix/", gene.column = 1, strip.suffix = T)
e12.4m <- Read10X("/scratch/project_2001045/kaia/E12_5_WT/Batch1_030220/Batch1_030220/count_200227_A00464_0167_BHKLYLDRXX/153-4-M/outs/filtered_feature_bc_matrix/", gene.column = 1, strip.suffix = T)
e12.5m <- Read10X("/scratch/project_2001045/kaia/E12_5_WT/Batch1_030220/Batch1_030220/count_200227_A00464_0167_BHKLYLDRXX/153-5-M/outs/filtered_feature_bc_matrix/", gene.column = 1, strip.suffix = T)

e13.6 <- Read10X("/scratch/project_2001045/sadikogl/E13_vR1/outs_r1-6/filtered_feature_bc_matrix",
                 gene.column = 1, strip.suffix = T)
e13.7 <- Read10X("/scratch/project_2001045/sadikogl/E13_vR1/outs_r1-7/filtered_feature_bc_matrix",
                 gene.column = 1, strip.suffix = T)
e13.12 <- Read10X("/scratch/project_2001045/sadikogl/E13_vR1/outs_r1-12/filtered_feature_bc_matrix",
                  gene.column = 1, strip.suffix = T)

e14.1 <- Read10X("/scratch/project_2001539/RNA_sc/RNAseq/Batch2_080819/count_190828_A00464_0092_AHLFLLDMXX/E14_vR1_1_RNA/outs/filtered_feature_bc_matrix", gene.column = 1)
e14.2 <- Read10X("/scratch/project_2001539/RNA_sc/RNAseq/Batch2_080819/count_190828_A00464_0092_AHLFLLDMXX/E14_vR1_2_RNA/outs/filtered_feature_bc_matrix", gene.column = 1)

e15.1 <- Read10X("/scratch/project_2001045/sadikogl/E15_tdT/E15_vR1_1_tdT/outs/filtered_feature_bc_matrix",
                 gene.column = 1, strip.suffix = T)
e15.2 <- Read10X("/scratch/project_2001045/sadikogl/E15_tdT/E15_vR1_2_tdT/outs/filtered_feature_bc_matrix",
                 gene.column = 1, strip.suffix = T)
e15.7 <- Read10X("/scratch/project_2001045/sadikogl/E15_tdT/E15_vR1_7_tdT/outs/filtered_feature_bc_matrix",
                 gene.column = 1, strip.suffix = T)
```

```{r import tsvs of features with ensembl-symbol mapping}
e12.features <- read.csv("/scratch/project_2001045/kaia/E12_5_WT/Batch1_030220/Batch1_030220/count_200227_A00464_0167_BHKLYLDRXX/153-1-F/outs/filtered_feature_bc_matrix/features.tsv.gz", sep = "\t", header = F) %>% tibble %>% rename("ENSEMBL_ID" = "V1", "gene_symbol" = "V2", "gene_expression" = "V3")

e13.features <- read.csv("/scratch/project_2001045/sadikogl/E13_vR1/outs_r1-6/filtered_feature_bc_matrix/genes.tsv", sep = "\t", header = F) %>% tibble %>% rename("ENSEMBL_ID" = "V1", "gene_symbol" = "V2", "gene_expression" = "V3")

e14.features <- read.csv("/scratch/project_2001539/RNA_sc/RNAseq/Batch2_080819/count_190828_A00464_0092_AHLFLLDMXX/E14_vR1_1_RNA/outs/filtered_feature_bc_matrix/features.tsv.gz", sep = "\t", header = F) %>% tibble %>% rename("ENSEMBL_ID" = "V1", "gene_symbol" = "V2", "gene_expression" = "V3")

e15.features <- read.csv("/scratch/project_2001045/sadikogl/E15_tdT/E15_vR1_1_tdT/outs/filtered_feature_bc_matrix/features.tsv.gz", sep = "\t", header = F) %>% tibble %>% rename("ENSEMBL_ID" = "V1", "gene_symbol" = "V2", "gene_expression" = "V3")

features.for.metadata <- list(e12.features, e13.features, e14.features, e15.features)
```

```{r create seurat objectes and combine to large list}
e12.list <- lapply(list(e12.1f, e12.7f, e12.4m, e12.5m), CreateSeuratObject)
e13.list <- lapply(list(e13.6, e13.7, e13.12), CreateSeuratObject)
e14.list <- lapply(list(e14.1, e14.2), CreateSeuratObject)
e15.list <- lapply(list(e15.1, e15.2, e15.7), CreateSeuratObject)

e12.list <- merge(e12.list[[1]], c(e12.list[[2]], e12.list[[3]], e12.list[[4]]), 
                  add.cell.ids = c("1F", "7F", "4M", "5M"))
e13.list <- merge(e13.list[[1]], c(e13.list[[2]], e13.list[[3]]),
                  add.cell.ids = c("R1.6", "R1.7", "R1.12"))
e14.list <- merge(e14.list[[1]], e14.list[[2]],
                  add.cell.ids = c("repl1", "repl2"))
e15.list <- merge(e15.list[[1]], c(e15.list[[2]], e15.list[[3]]),
                  add.cell.ids = c("E15.R1.1", "E15.R1.2", "E15.R1.7"))

e.all.combined <- list(e12.list, e13.list, e14.list, e15.list)
names(e.all.combined) <- c("e12", "e13", "e14", "e15")
```

```{r add feature metadata containing features from previous block}
for (idx in 1:length(e.all.combined)) {

   e.all.combined[[idx]][["RNA"]] <- AddMetaData(
     object = e.all.combined[[idx]][["RNA"]],
     metadata = features.for.metadata[[idx]]$gene_symbol,
     col.name = "feature_symbol")

}
```

```{r mitcochondrial features}
for (idx in 1:length(e.all.combined)) {

  # Get mt gene symbols
  feature.map <- e.all.combined[[idx]]@assays[["RNA"]]@meta.features[["feature_symbol"]]
  # Get corresponding ensembl ids
  mt.features <- rownames(e.all.combined[[idx]])[grep("^MT-",
                                                      feature.map,
                                                      ignore.case = T)]
  # Add mt percentages to metadata
  e.all.combined[[idx]][["percent.mt"]] <- PercentageFeatureSet(e.all.combined[[idx]],
                                                                features = mt.features)

}
```

```{r generate plot QC}
nfeature.plot.list <- lapply(1:length(e.all.combined), function(idx) {
  t.p <- names(e.all.combined)[idx]
  plt <- VlnPlot(e.all.combined[[idx]], features = "nFeature_RNA") + 
    ggtitle(t.p) +
    NoLegend()
})

ncount.plot.list <- lapply(1:length(e.all.combined), function(idx) {
  t.p <- names(e.all.combined)[idx]
  plt <- VlnPlot(e.all.combined[[idx]], features = "nCount_RNA") + 
    ggtitle(t.p) +
    NoLegend()
})

pctmt.plot.list <- lapply(1:length(e.all.combined), function(idx) {
  t.p <- names(e.all.combined)[idx]
  plt <- VlnPlot(e.all.combined[[idx]], features = "percent.mt") + 
    ggtitle(t.p) +
    NoLegend()
})

```

```{r}
patchwork::wrap_plots(
  nfeature.plot.list[[1]] + scale_y_continuous(breaks = round(x = seq(0,
                                               max(nfeature.plot.list[[1]]$data$nFeature_RNA),
                                               by = 500))),
  nfeature.plot.list[[2]] + scale_y_continuous(breaks = round(x = seq(0,
                                               max(nfeature.plot.list[[2]]$data$nFeature_RNA),
                                               by = 500))),
  nfeature.plot.list[[3]] + scale_y_continuous(breaks = round(x = seq(0,
                                               max(nfeature.plot.list[[3]]$data$nFeature_RNA),
                                               by = 500))),
  nfeature.plot.list[[4]] + scale_y_continuous(breaks = round(x = seq(0,
                                               max(nfeature.plot.list[[4]]$data$nFeature_RNA),
                                               by = 500))),
  ncol = 4
)
```

```{r}
patchwork::wrap_plots(
  ncount.plot.list[[1]] + scale_y_continuous(breaks = round(x = seq(0,
                                               max(ncount.plot.list[[1]]$data$nCount_RNA),
                                               by = 10000))),
  ncount.plot.list[[2]] + scale_y_continuous(breaks = round(x = seq(0,
                                               max(ncount.plot.list[[2]]$data$nCount_RNA),
                                               by = 10000))),
  ncount.plot.list[[3]] + scale_y_continuous(breaks = round(x = seq(0,
                                               max(ncount.plot.list[[3]]$data$nCount_RNA),
                                               by = 10000))),
  ncount.plot.list[[4]] + scale_y_continuous(breaks = round(x = seq(0,
                                               max(ncount.plot.list[[4]]$data$nCount_RNA),
                                               by = 10000))),
  ncol = 4
)
```

```{r}
patchwork::wrap_plots(
  pctmt.plot.list[[1]] + scale_y_continuous(breaks = round(x = seq(0,
                                               max(pctmt.plot.list[[1]]$data$percent.mt),
                                               by = 5))),
  pctmt.plot.list[[2]] + scale_y_continuous(breaks = round(x = seq(0,
                                               max(pctmt.plot.list[[2]]$data$percent.mt),
                                               by = 5))),
  pctmt.plot.list[[3]] + scale_y_continuous(breaks = round(x = seq(0,
                                               max(pctmt.plot.list[[3]]$data$percent.mt),
                                               by = 5))),
  pctmt.plot.list[[4]] + scale_y_continuous(breaks = round(x = seq(0,
                                               max(pctmt.plot.list[[4]]$data$percent.mt),
                                               by = 5))),
  ncol = 4
)
```

```{r QC}
# nFeature_RNA lower bounds for QC filtering
nf.lb <- c(3000, 3000, 3000, 2500)
# nFeature_RNA upper bounds for QC filtering
nf.ub <- c(5500, 5000, 5000, 5000)
# Mt pct upper bounds for QC filtering
pctmt.ub <- rep(10, 4)

e.all.combined <- lapply(1:length(e.all.combined), function (idx) {
  subset(e.all.combined[[idx]],
         subset = nFeature_RNA > nf.lb[idx] & nFeature_RNA < nf.ub[idx] & percent.mt < pctmt.ub[idx])
})
```

Summarizing

```{r}
VlnPlot(e.all.combined[[1]], features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
```

```{r}
VlnPlot(e.all.combined[[2]], features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
```

```{r}
VlnPlot(e.all.combined[[3]], features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
```

```{r}
VlnPlot(e.all.combined[[4]], features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
```

#### Normalization

```{r normalization}
for (idx in 1:length(e.all.combined)) {
  e.all.combined[[idx]] <-
    NormalizeData(e.all.combined[[idx]],
                  normalization.method = "LogNormalize",
                  scale.factor = 10000,
                  verbose = F) %>% 
    FindVariableFeatures(selection.method = "vst",
                         nfeatures = 3000,
                         verbose = F)
    
}
```

### Scaling

```{r scaling}
for (idx in 1:length(e.all.combined)) {
  # Keep track which one is being processed
  print(idx)
  # preferably NOT RUN, runs for > 10 hours
  e.all.combined[[idx]] <- ScaleData(e.all.combined[[idx]],
                                     features = rownames(e.all.combined[[idx]]),
                                     vars.to.regress = c("nFeature_RNA", "nCount_RNA", "percent.mt"),
                                     verbose = F)
}

<<<<<<< Updated upstream
=======
<<<<<<< HEAD
saveRDS(e.all.combined, "/scratch/project_2001045/lassi/integration/pipeline_remodel/Seurat_integration/data/e_all_rescaled_regress_nuisance_seurat405.Rds")
=======
>>>>>>> Stashed changes
# Data object saved to avoid running again
saveRDS(e.all.combined, "/scratch/project_2001045/lassi/integration/pipeline_remodel/Seurat_integration/data/e_all_rescaled_regress_nuisance.Rds")
>>>>>>> 03fe1707127ca8423f3406b78ba33fa2352f42f9
```

```{r}
e.all.combined <- readRDS("/scratch/project_2001045/lassi/integration/pipeline_remodel/Seurat_integration/data/e_all_rescaled_regress_nuisance.Rds")
# Saved for local plotting
# saveRDS(e.all.combined[4], "/scratch/project_2001045/lassi/integration/pipeline_remodel/Seurat_integration/data/e15_from_e_all_combined_scaled.Rds")
```

### PCA

```{r run pca}
for (idx in 1:length(e.all.combined)) {
  e.all.combined[[idx]] <- RunPCA(e.all.combined[[idx]],
                                  features = VariableFeatures(e.all.combined[[idx]]),
                                  verbose = F)
}
```

```{r}
ElbowPlot(e.all.combined[[idx]], ndims = 40) # 19
```

```{r}
ElbowPlot(e.all.combined[[2]], ndims = 40) # 20
```

```{r}
ElbowPlot(e.all.combined[[3]], ndims = 40) # 21
```

```{r}
ElbowPlot(e.all.combined[[4]], ndims = 40) # 19
```

### Clustering

```{r}
# Got from above plots
pca.dims <- c(19, 20, 21, 19)
```

```{r clustering}
# Iteratively selected in range 0.1:3
resolution.list <- c(2.1, 2.1, 1.8, 2.5)

for (idx in 1:length(e.all.combined)) {
  e.all.combined[[idx]] <-
    FindNeighbors(e.all.combined[[idx]],
                  dims = 1:pca.dims[idx],
                  verbose = F) %>% 
    FindClusters(method = "matrix",
                 resolution = resolution.list[idx],
                 verbose = F)
}
```

#### UMAP

```{r run umap}
# Iteratively chosen between 0.2 and 2 to enhance local structure of rV2 GABA
spread.list <- c(1, 1.8, 1.2, 1.5)

for (idx in 1:length(e.all.combined)) {
  e.all.combined[[idx]] <- RunUMAP(e.all.combined[[idx]],
                                   dims = 1:pca.dims[idx],
                                   spread = spread.list[idx],
                                   verbose = F)
}
```

```{r}
patchwork::wrap_plots(
  DimPlot(e.all.combined[[1]]) + NoLegend(),
  DimPlot(e.all.combined[[2]]) + NoLegend(),
  DimPlot(e.all.combined[[3]]) + NoLegend(),
  DimPlot(e.all.combined[[4]]) + NoLegend()
)
```

### Cell cycle score

Note that these genes are HS genes

```{r get cc ens ids}
feature.map <- data.frame(e.all.combined[[1]]@assays[["RNA"]]@meta.features[["feature_symbol"]])
rownames(feature.map) <- rownames(e.all.combined[[1]])
colnames(feature.map) <- "gene_symbol"

# Get ENSEMBL IDs of S phase associated genes
s.ids <- feature.map %>% filter(gene_symbol %in% stringr::str_to_title(cc.genes$s.genes))
s.ids <- rownames(s.ids)

# Get ENSEMBL IDs of G2/M phase associated genes
g2m.ids <- feature.map %>% filter(gene_symbol %in% stringr::str_to_title(cc.genes$g2m.genes))
g2m.ids <- rownames(g2m.ids)
```

```{r cc scoring}
for (idx in 1:length(e.all.combined)) {
  e.all.combined[[idx]] <- CellCycleScoring(e.all.combined[[idx]],
                                            s.features = s.ids,
                                            g2m.features = g2m.ids)
  
  e.all.combined[[idx]]$CC.Difference <- e.all.combined[[idx]]$S.Score - e.all.combined[[idx]]$G2M.Score
}
```

This is the point where saving full data objects for parallel analyses can be done

```{r}
# Saved for Sami on Fri 15 oct
saveRDS(e.all.combined[[1]], "/scratch/project_2001045/Sami/E12R1_data_files/e12_ens_whole_rescaled.Rds")

# Saved for general purposes on Wed 3 Oct
saveRDS(e.all.combined, "/scratch/project_2001045/lassi/integration/pipeline_remodel/Seurat_integration/data/E_all_rerun_complete_031121.Rds")
```

```{r}
# Checkpoint, skip lines above if running them not necessary
e.all.combined <- readRDS("/scratch/project_2001045/lassi/integration/pipeline_remodel/Seurat_integration/data/E_all_rerun_complete_031121.Rds")

# Reading in one table to be able to map ensmus id to symbol
e12.features <- read.csv("/scratch/project_2001045/kaia/E12_5_WT/Batch1_030220/Batch1_030220/count_200227_A00464_0167_BHKLYLDRXX/153-1-F/outs/filtered_feature_bc_matrix/features.tsv.gz", sep = "\t", header = F) %>% tibble %>% rename("ENSEMBL_ID" = "V1", "gene_symbol" = "V2", "gene_expression" = "V3")
# Discard unnecessay numeric values
e12.features <- e12.features[,1:2]
```

No significant difference between scores in idents of interest

```{r}
patchwork::wrap_plots(
  FeaturePlot(e.all.combined[[1]], features = "CC.Difference"),
  FeaturePlot(e.all.combined[[2]], features = "CC.Difference"),
  FeaturePlot(e.all.combined[[3]], features = "CC.Difference"),
  FeaturePlot(e.all.combined[[4]], features = "CC.Difference")
)
```

### Identification or rV2 GABA lineages

```{r}
gaba.biomarkers <- c("Tal1", "Pdzk1ip1", "Gata2", "Gata3", "Gad1", "Gad2")
serot.biomarkers <- c("Fev")

feature.map <- data.frame(e.all.combined[[1]]@assays[["RNA"]]@meta.features[["feature_symbol"]])
rownames(feature.map) <- rownames(e.all.combined[[1]])
colnames(feature.map) <- "gene_symbol"

gaba.ids <- feature.map %>% filter(gene_symbol %in% gaba.biomarkers)
gaba.ids <- rownames(gaba.ids)

serot.ids <- feature.map %>% filter(gene_symbol %in% serot.biomarkers)
serot.ids <- rownames(serot.ids)
```

### Subset into rV2 GABA lineages

```{r}
e12.gaba <- subset(e.all.combined[[1]], idents = c(2, 7, 15, 20, 25))
e13.gaba <- subset(e.all.combined[[2]], idents = c(7, 8, 10, 21, 28))
e14.gaba <- subset(e.all.combined[[3]], idents = c(2, 8, 10, 14, 25, 30))
e15.gaba <- subset(e.all.combined[[4]], idents = c(1, 3, 10, 15, 20, 40))
```

### Integration

```{r}
e12.gaba@meta.data$timepoint <- rep("E12.5", nrow(e12.gaba@meta.data))
e13.gaba@meta.data$timepoint <- rep("E13.5", nrow(e13.gaba@meta.data))
e14.gaba@meta.data$timepoint <- rep("E14.5", nrow(e14.gaba@meta.data))
e15.gaba@meta.data$timepoint <- rep("E15.5", nrow(e15.gaba@meta.data))
```

```{r Removing Glut cells by ID}
# ENSEMBL
e12.gaba <- subset(e12.gaba, 
                   subset = ENSMUSG00000055197 == 0.0 & ENSMUSG00000033080 == 0.0 & ENSMUSG00000021239 == 0.0)
e13.gaba <- subset(e13.gaba, 
                   subset = ENSMUSG00000055197 == 0.0 & ENSMUSG00000033080 == 0.0 & ENSMUSG00000021239 == 0.0)
```

```{r Typical integration workflow}
set.list <- list(e12.gaba, e13.gaba, e14.gaba, e15.gaba)

i.feat <- SelectIntegrationFeatures(object.list = set.list, nfeatures = 4500, verbose = F)

integ.anchors <- FindIntegrationAnchors(object.list = set.list,
                                        anchor.features = i.feat,
                                        scale = F,
                                        verbose = F)

e.all.integrated <- IntegrateData(integ.anchors, verbose = F)
```

```{r}
# Adding gene symbol info
e.all.int.features <- data.frame(rownames(e.all.integrated[["RNA"]]))
colnames(e.all.int.features) <- "ENSEMBL_ID"

e.all.integrated.rows <- left_join(e.all.int.features, e12.features,
                                   by = c("ENSEMBL_ID" = "ENSEMBL_ID"))

e.all.integrated[["RNA"]] <- AddMetaData(
     object = e.all.integrated[["RNA"]],
     metadata = e.all.integrated.rows$gene_symbol,
     col.name = "feature_symbol")
```

```{r}
DefaultAssay(e.all.integrated) <- "integrated"

e.all.integrated <- ScaleData(e.all.integrated, verbose = F, vars.to.regress = c("nFeature_RNA", "nCount_RNA", "percent.mt"))
e.all.integrated <- RunPCA(e.all.integrated, verbose = F, npcs = 50)
ElbowPlot(e.all.integrated, ndims = 50)
```

```{r}
# Dims were 50 for non rescaled run
e.all.integrated <- RunUMAP(e.all.integrated, dims = 1:31, verbose = F, spread = 1.9, min.dist = 0.2) # 1.8 originally
e.all.integrated <- FindNeighbors(e.all.integrated, dims = 1:31, verbose = F)
e.all.integrated <- FindClusters(e.all.integrated, resolution = 1.1, verbose = F)
```

```{r}
patchwork::wrap_plots(
  DimPlot(e.all.integrated, group.by = "timepoint") + ggtitle("Time points"),
  DimPlot(e.all.integrated, label = TRUE, label.size = 4, repel = TRUE) + ggtitle("Clustering") + NoLegend()
)
```

### Cluster biomarkers

```{r}
DefaultAssay(e.all.integrated) <- "RNA"
all.markers <- FindAllMarkers(e.all.integrated)
saveRDS(all.markers, file = "/scratch/project_2001045/lassi/integration/pipeline_remodel/Seurat_integration/data/integrated_markers_051121.Rds")
```

```{r}
`%notin%` <- purrr::negate(`%in%`)
all.markers <- readRDS("/scratch/project_2001045/lassi/integration/pipeline_remodel/Seurat_integration/data/integrated_markers_051121.Rds")
all.markers$pct_diff <- all.markers$pct.1 - all.markers$pct.2
all.markers <- all.markers %>% filter(gene %notin% "TDTOMATOG")
```

```{r}
# Note sign to select markers with lowest p-val
top10.markers <- all.markers %>% group_by(cluster) %>% top_n(-10, p_val)

# Filtering based on pct_diff
top10.markers.filt <- all.markers %>% group_by(cluster) %>% filter(abs(pct_diff) > 1/3) %>% top_n(10, abs(avg_log2FC))
top10.m.f.s <- left_join(top10.markers.filt, e12.features, by = c("gene" = "ENSEMBL_ID"))

# Same with top 5
top5.markers.filt <- all.markers %>% group_by(cluster) %>% filter(abs(pct_diff) > 1/3) %>% top_n(5, abs(avg_log2FC))
top5.m.f.s <- left_join(top5.markers.filt, e12.features, by = c("gene" = "ENSEMBL_ID"))
```

```{r Visualization of markers}
DefaultAssay(e.all.integrated) <- "RNA"
marker.dp <- DotPlot(e.all.integrated, features = unique(top5.m.f.s$gene)) + RotatedAxis()
marker.dp + scale_x_discrete(labels = top5.m.f.s$gene_symbol)

marker.dp.clust <- DotPlot(e.all.integrated, features = unique(top5.m.f.s$gene), cluster.idents = T) + RotatedAxis()
marker.dp.clust + 
  scale_x_discrete(labels = unique(top5.m.f.s$gene_symbol)) +
  theme(axis.text.x = element_text(size = 10, angle = 45))
```

#### Appendix 0: Plot previously gathered marker genes

```{r}
old_markers <- read_csv("../data/first_round_of_markers_scale_F.csv")
```

```{r}
old_markers$pct_diff <- old_markers$pct.1 - old_markers$pct.2

old_markers.filt <- old_markers %>% 
  group_by(cluster) %>% 
  filter(abs(pct_diff) > 0.2 & abs(avg_log2FC) > 0.9) %>% 
  top_n(8, myAUC)
old_markers.ids <- convert_feature_identity(e.all.integrated, "RNA", old_markers.filt$gene, "symbol")
failed.matches <- convert_feature_identity(e.all.integrated, "RNA", c("Selenow", "Jpt1"), "symbol")

# Conversion of NAs into ENSs
old_markers.filt$ENS_ID <- old_markers.ids
old_markers.filt[82,]$ENS_ID <- failed.matches[1]
old_markers.filt[83,]$ENS_ID <- failed.matches[2]

DefaultAssay(e.all.integrated) <- "RNA"

fp.list <- lapply(unique(old_markers.filt$cluster), function (cl) {
  FeaturePlot(e.all.integrated,
              features = old_markers.filt %>% filter(cluster == cl) %>% pull(ENS_ID),
              combine = F)
})

# Plot as so:
fp.list.symb <- lapply(1:length(fp.list), function (i) {
  cluster_index <- i
  cluster_number <- i - 1
  n_markers <- length(fp.list[[cluster_index]])
  marker.ss <- old_markers.filt %>% filter(cluster == cluster_number) %>% pull(gene)
  
  plot_list <- lapply(1:n_markers, function(j) {
    ens <- colnames(fp.list[[i]][[j]]$data)[4]
    symbol <- old_markers.filt %>% filter(ENS_ID == ens) %>% pull(gene)
    fp.list[[i]][[j]] + ggtitle(symbol)
  })
})
```

```{r}
`%notin%` <- purrr::negate(`%in%`)

# Or solely positive markers
old_markers.pos.filt <- old_markers %>% 
  group_by(cluster) %>% 
  filter(pct_diff > 0.2 & avg_log2FC > 0.9) %>% 
  top_n(8, myAUC)

old_markers.pos.filt$ENS_ID <- convert_feature_identity(e.all.integrated, "RNA", old_markers.pos.filt$gene, "symbol")
old_markers.pos.filt$ENS_ID[is.na(old_markers.pos.filt$ENS_ID)] <- "conversion_fail"
old_markers.pos.filt <- old_markers.pos.filt[!grepl("conversion_fail", old_markers.pos.filt$ENS_ID),]

DefaultAssay(e.all.integrated) <- "RNA"
pos.fp.list <- lapply(unique(old_markers.pos.filt$cluster), function (cl) {
  FeaturePlot(e.all.integrated,
              features = old_markers.pos.filt %>% filter(cluster == cl) %>% pull(ENS_ID),
              combine = F)
})

pos.fp.list.symb <- lapply(1:length(pos.fp.list), function (i) {
  cluster_index <- i
  cluster_number <- i - 1
  marker.ss <- old_markers.pos.filt %>% filter(cluster == cluster_number)
  n_markers <- nrow(marker.ss)
  
  plot_list <- lapply(1:n_markers, function(j) {
    ens <- colnames(pos.fp.list[[i]][[j]]$data)[4]
    symbol <- old_markers.pos.filt %>% filter(ENS_ID == ens) %>% pull(gene)
    fp.list[[i]][[j]] + ggtitle(symbol)
  })
})
```

```{r}
px.dims <- c(1280, 672)
dir.path.lin <- "../plots/wed10nov/"
wd.curr <- getwd()

# NOT RUN THIS IS BS
for (i in unique(old_markers.filt$cluster)) {
  list.idx <- i + 1
  dir.path.cl <- paste0(dir.path.lin, "cluster") %>% paste0(i) %>% paste0("/")
  
  dir.create(dir.path.cl)
  setwd(dir.path.cl)
  
  png(filename = "markers.png", width = 2000)
  cowplot::plot_grid(plotlist = fp.list.symb[[list.idx]])
  dev.off()
  
}

setwd(wd.curr)
DefaultAssay(e.all.integrated) <- "integrated"
```


#### Appendix 1: Wrangling E15 for cell selection

```{r}
patchwork::wrap_plots(
  FeaturePlot(e.all.combined[[4]], features = gaba.ids[1]) + ggtitle(gaba.biomarkers[1]),
  FeaturePlot(e.all.combined[[4]], features = gaba.ids[2]) + ggtitle(gaba.biomarkers[2]),
  FeaturePlot(e.all.combined[[4]], features = gaba.ids[3]) + ggtitle(gaba.biomarkers[3]),
  FeaturePlot(e.all.combined[[4]], features = gaba.ids[4]) + ggtitle(gaba.biomarkers[4])
)
```

```{r}
patchwork::wrap_plots(
  FeaturePlot(e.all.combined[[4]], features = gaba.ids[5]) + ggtitle(gaba.biomarkers[5]),
  FeaturePlot(e.all.combined[[4]], features = gaba.ids[6]) + ggtitle(gaba.biomarkers[6]),
  FeaturePlot(e.all.combined[[4]], features = serot.ids) + ggtitle(serot.biomarkers[1]),
  DimPlot(e.all.combined[[4]], label = T)
)
```

```{r}
e15.subs <- subset(e.all.combined[[4]],
                   idents = c(0, 1, 3, 10, 15, 20, 30, 38, 40))
```

```{r}
e15.subs <- RunUMAP(e15.subs, dims = 1:pca.dims[4], spread = 2.5, verbose = F,
                    min.dist = 0.1)
```

```{r}
e15.subs <- FindNeighbors(e15.subs, dims = 1:31, verbose = F)
e15.subs <- FindClusters(e15.subs, resolution = 1, verbose = F)
```

```{r}
patchwork::wrap_plots(
  FeaturePlot(e15.subs, features = gaba.ids[1]) + NoLegend(),
  FeaturePlot(e15.subs, features = gaba.ids[2]) + NoLegend(),
  FeaturePlot(e15.subs, features = gaba.ids[3]) + NoLegend(),
  FeaturePlot(e15.subs, features = gaba.ids[4]) + NoLegend()
)
```

#### Appendix 2: Selection of lineages from original data objects

```{r}
cluster.selection.symbols <- c("Pdzk1ip1", "Tal1", "Gata2", "Gata3", "Gad1", "Gad2")
cluster.selection.ids <- e12.features %>% filter(gene_symbol %in% cluster.selection.symbols) %>% pull(ENSEMBL_ID)
```

```{r}
FeaturePlot(e.all.combined[[1]], features = cluster.selection.ids, label = T) + NoLegend()
FeaturePlot(e.all.combined[[2]], features = cluster.selection.ids, label = T) + NoLegend()
FeaturePlot(e.all.combined[[3]], features = cluster.selection.ids, label = T) + NoLegend() 
FeaturePlot(e.all.combined[[1]], features = cluster.selection.ids, label = T) + NoLegend()
```

