---
title: "R Notebook of analysis of regulatory relations from fp,acc,exp and C&T data"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  html_notebook:
    code_folding: hide
---

```{r Packages, message=FALSE}
library(rtracklayer)
library(qs)
library(Seurat)
library(Signac)
library(tidyverse)
library(GenomicRanges)
library(parallel)
library(dbplyr)
library(DBI)
```


```{r Additional functions}
message_parallel <- function(...){
  system(sprintf('echo "\n%s\n"', paste0(..., collapse="")))
}
```

```{r Connection to SQLite, eval=FALSE}
con.obj <- DBI::dbConnect(RSQLite::SQLite(), dbname = "~/Workspace/TOBIAS.dr.h12_030324.sqlite")
```

```{r Example of fetching factors give group, gene_name}
test.tal1 <- extract.factors(db.name = "~/Workspace/TOBIAS.dr.h12_030324.sqlite", group_name = "CO1_2", gene_name = "Tal1", zscore.thr=0)

test.gata2 <- extract.factors(db.name = "~/Workspace/TOBIAS.dr.h12_030324.sqlite", group_name = "CO1_2", gene_name = "Gata2", zscore.thr=0)

test.gata3 <- extract.factors(db.name = "~/Workspace/TOBIAS.dr.h12_030324.sqlite", group_name = "CO1_2", gene_name = "Gata3", zscore.thr=0)

Reduce(intersect, list(test.tal1,test.gata2,test.gata3))

```

```{r}
test.1 <- dbGetQuery(con.obj, 'SELECT * FROM feature WHERE seqnames="chr4" AND start>=114986077 AND end<=115134633')

test.tal1 <- as_tibble(dbGetQuery(con.obj, 'SELECT tb.* FROM tobias as tb, exp as exp, links as links, gene_metadata as gm WHERE tb.features==links.feature AND mean_cons>0.5 AND exp.ensg_id=tb.ensg_id AND (tb.GA1_2_bound=1) AND (exp.GA1_2>1.2) AND links.ensg_id=gm.ensg_id AND gm.gene_name="Tal1" AND links.zscore>0 AND links.feature=tb.features'))

test.gata2 <- as_tibble(dbGetQuery(con.obj, 'SELECT tb.* FROM tobias as tb,feature as ft, exp as exp WHERE ft.seqnames="chr6" AND ft.start>=88103987 AND ft.end<=88301611 AND tb.features==ft.feature AND mean_cons>0.5 AND exp.ensg_id=tb.ensg_id AND (tb.GA1_2_bound=1) AND (exp.GA1_2>1.2)'))

test.gata3 <- as_tibble(dbGetQuery(con.obj, 'SELECT tb.* FROM tobias as tb,feature as ft, exp as exp WHERE ft.seqnames="chr2" AND ft.start>=9834965 AND ft.end<=9996391 AND tb.features==ft.feature AND mean_cons>0.5 AND exp.ensg_id=tb.ensg_id AND (tb.GA1_2_bound=1) AND (exp.GA1_2>1.2)'))


intersect(intersect(test.gata2 %>% distinct(TF_gene_name) %>% pull(TF_gene_name), test.tal1 %>% distinct(TF_gene_name) %>% pull(TF_gene_name)),test.gata3 %>% distinct(TF_gene_name) %>% pull(TF_gene_name))


```

```{r}
tobias.table <- tbl(con.obj, "tobias")
exp.table <- tbl(con.obj, "exp")
acc.table <- tbl(con.obj, "acc")

table.tmp.1 <- dplyr::filter(tobias.table, features==feature.coords) %>% left_join(exp.table) %>% left_join(acc.table, by=c("features"="features"))

table.tmp.2 <- table.tmp.1 %>% collect()
  
table.tmp.2 <- table.tmp.2 %>% filter((abs(PRO1_2.x)>exp.thr | abs(CO1_2.x)>exp.thr | abs(GA1_2.x)>exp.thr) & (PRO1_2_bound==1 | CO1_2_bound==1 | GA1_2_bound==1) & mean_cons>mean_cons_thr) %>% arrange(start)
  
```

```{r}
tobias.table <- tbl(con.obj, "tobias")
acc.table <- tbl(con.obj, "acc")

min.acc <- min(pull(acc.table,CO1_2))
max.acc <- max(pull(acc.table,CO1_2))

bound.query <- paste("SELECT SUM(CASE WHEN tb.CO1_2_bound=1 THEN 1 ELSE 0 END) AS Bounds, SUM(CASE WHEN tb.CO1_2_bound=0 THEN 1 ELSE 0 END) AS Unbounds FROM tobias as tb, acc as ac WHERE ac.features=tb.features AND ac.CO1_2>0")

table.tmp.1 <- left_join(tobias.table, acc.table, by=c("features"="features")) %>% filter(CO1_2_bound==1 & CO1_2>0)
table.tmp.2 <- collect(table.tmp.1)

```

