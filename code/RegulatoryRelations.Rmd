---
title: "R Notebook of analysis of regulatory relations from fp,acc,exp and C&T data"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  html_notebook:
    code_folding: hide
---

```{r Packages, message=FALSE}
library(rtracklayer)
library(qs)
library(Seurat)
library(Signac)
library(tidyverse)
library(GenomicRanges)
library(parallel)
library(dbplyr)
library(DBI)
source("../../AuxCode/TOBIAS_tools.R")
```


```{r Additional functions}
message_parallel <- function(...){
  system(sprintf('echo "\n%s\n"', paste0(..., collapse="")))
}
```

```{r Connection to SQLite, eval=FALSE}
con.obj <- DBI::dbConnect(RSQLite::SQLite(), dbname = "~/Workspace/TOBIAS.dr.h12_030324.sqlite")
```

```{r Example of fetching factors give group, gene_name}
test.tal1 <- extract.factors(db.name = "~/Workspace/TOBIAS.dr.h12_210324.sqlite", group_name = "CO1_2", gene_name = "Tal1", zscore.thr=2)

test.gata2 <- extract.factors(db.name = "~/Workspace/TOBIAS.dr.h12_210324.sqlite", group_name = "CO1_2", gene_name = "Gata2", zscore.thr=2)

test.gata3 <- extract.factors(db.name = "~/Workspace/TOBIAS.dr.h12_210324.sqlite", group_name = "CO1_2", gene_name = "Gata3", zscore.thr=2)

test.ahr <- extract.factors(db.name = "~/Workspace/TOBIAS.dr.h12_210324.sqlite", group_name = "CO1_2", gene_name = "Ahr", zscore.thr=2)

lists <- list(test.tal1,test.gata2,test.gata3)

Reduce(intersect, lists)

common.regulator.stat.test(lists, total.TF.count = 950)
common.regulator.stat.test(list(A=c("Tal1","Gata2"),B=c("Tal1","Gata2","Myc")), total.TF.count = 950)
```

```{r}
test.1 <- dbGetQuery(con.obj, 'SELECT * FROM feature WHERE seqnames="chr4" AND start>=114986077 AND end<=115134633')

test.tal1 <- as_tibble(dbGetQuery(con.obj, 'SELECT tb.* FROM tobias as tb, exp as exp, links as links, gene_metadata as gm WHERE tb.features==links.feature AND mean_cons>0.5 AND exp.ensg_id=tb.ensg_id AND (tb.GA1_2_bound=1) AND (exp.GA1_2>1.2) AND links.ensg_id=gm.ensg_id AND gm.gene_name="Tal1" AND links.zscore>0 AND links.feature=tb.features'))

test.gata2 <- as_tibble(dbGetQuery(con.obj, 'SELECT tb.* FROM tobias as tb,feature as ft, exp as exp WHERE ft.seqnames="chr6" AND ft.start>=88103987 AND ft.end<=88301611 AND tb.features==ft.feature AND mean_cons>0.5 AND exp.ensg_id=tb.ensg_id AND (tb.GA1_2_bound=1) AND (exp.GA1_2>1.2)'))

test.gata3 <- as_tibble(dbGetQuery(con.obj, 'SELECT tb.* FROM tobias as tb,feature as ft, exp as exp WHERE ft.seqnames="chr2" AND ft.start>=9834965 AND ft.end<=9996391 AND tb.features==ft.feature AND mean_cons>0.5 AND exp.ensg_id=tb.ensg_id AND (tb.GA1_2_bound=1) AND (exp.GA1_2>1.2)'))


intersect(intersect(test.gata2 %>% distinct(TF_gene_name) %>% pull(TF_gene_name), test.tal1 %>% distinct(TF_gene_name) %>% pull(TF_gene_name)),test.gata3 %>% distinct(TF_gene_name) %>% pull(TF_gene_name))


```

```{r}
tobias.table <- tbl(con.obj, "tobias")
exp.table <- tbl(con.obj, "exp")
acc.table <- tbl(con.obj, "acc")

table.tmp.1 <- dplyr::filter(tobias.table, features==feature.coords) %>% left_join(exp.table) %>% left_join(acc.table, by=c("features"="features"))

table.tmp.2 <- table.tmp.1 %>% collect()
  
table.tmp.2 <- table.tmp.2 %>% filter((abs(PRO1_2.x)>exp.thr | abs(CO1_2.x)>exp.thr | abs(GA1_2.x)>exp.thr) & (PRO1_2_bound==1 | CO1_2_bound==1 | GA1_2_bound==1) & mean_cons>mean_cons_thr) %>% arrange(start)
  
```

```{r, eval=FALSE}
acc.table <- tbl(con.obj, "acc")

min.acc <- min(pull(acc.table,CO1_2))
max.acc <- max(pull(acc.table,CO1_2))
acc.steps <- seq(min.acc,max.acc, by=0.25)

bound.ratios <- lapply(acc.steps[-1],function(step){
  bound.query <- paste("SELECT SUM(CASE WHEN tb.CO1_2_bound=1 THEN 1 ELSE 0 END) AS Bounds, SUM(CASE WHEN tb.CO1_2_bound=0 THEN 1 ELSE 0 END) AS Unbounds FROM tobias as tb, acc as ac WHERE ac.features=tb.features AND ac.CO1_2 BETWEEN",step-0.25,"AND",step,";",sep=" ")
  as_tibble(dbGetQuery(con, bound.query))
})

saveRDS(bound.ratios, file="../analysis/bound.ratios.Rds")
```

```{r}
bound.ratios.tb <- as_tibble(do.call(rbind,bound.ratios))
bound.ratios.tb$ratio <- bound.ratios.tb$Bounds/bound.ratios.tb$Unbounds
bound.ratios.tb$acc_range <- factor(paste(acc.steps-0.25,acc.steps,sep="-")[-1])

df_long <- bound.ratios.tb %>% pivot_longer(cols = c(Bounds, Unbounds), names_to = "Type", values_to = "Value")
df_long$Value <- log2(df_long$Value)
df_long$Value[!is.finite(df_long$Value)]<-0
         
ggplot(data = df_long, aes(x = acc_range, y = Value, fill = Type)) +
  geom_bar(stat = "identity", position = position_dodge(), width = 0.7) +
  geom_line(data = df_long, aes(x = acc_range, y = ratio, group = 1), color = "blue", linetype = "dashed") +
  scale_y_continuous(sec.axis = sec_axis(~ ., name = "Ratio")) +
  labs(y = "Value", x = "Accessibility") +
  theme_minimal() + ylab("log2(count)") + ggtitle("Bound/Unboud counts in CO1_2 per Acc range")
```

```{r}
bound.ratios.tb <- as_tibble(do.call(rbind,bound.ratios))
bound.ratios.tb$ratio <- bound.ratios.tb$Bounds/bound.ratios.tb$Unbounds
bound.ratios.tb$acc_range <- factor(paste(acc.steps-0.25,acc.steps,sep="-")[-1])

df_long <- bound.ratios.tb %>% pivot_longer(cols = c(Bounds, Unbounds), names_to = "Type", values_to = "Value")

ggplot(data = df_long, aes(x = acc_range, y = Value, fill = Type)) +
  geom_bar(stat = "identity", position = position_dodge(), width = 0.7) +
  geom_line(data = df_long, aes(x = acc_range, y = ratio, group = 1), color = "blue", linetype = "dashed") +
  scale_y_continuous(sec.axis = sec_axis(~ ., name = "Ratio")) +
  labs(y = "Value", x = "Accessibility") +
  theme_minimal() + ylab("Count") + ggtitle("Bound/Unboud counts in CO1_2 per Acc range")
```


```{r}

feature <- "chr1-3670394-3672637"

all.features<- na.omit(as.vector(dbGetQuery(con, "SELECT DISTINCT(features) FROM tobias;"))[[1]])

MIs.per.feature <- mclapply(all.features, function(feature){
  feature.fetch.query <- paste("SELECT PRO1_2_bound,CO1_2_bound,GA1_2_bound,GA3_4_bound,GA5_6_bound, GL1_2_bound,GL3_4_bound,GL5_bound, PRO1_2, CO1_2, GA1_2,GA3_4,GA5_6,GL1_2,GL3_4,GL5 FROM tobias as tb, acc as ac WHERE ac.features=tb.features AND tb.features='",feature,"';",sep="")
  feat.data.tmp <- as_tibble(dbGetQuery(con, feature.fetch.query))
    
  MIs.feature <- sapply(1:nrow(feat.data.tmp),function(row.i){
  mut.tmp <- mutinformation(discretize(as.numeric(feat.data.tmp[row.i,9:16]), disc="equalwidth"), Y = as.numeric(feat.data.tmp[row.i,1:8]))
  return(mut.tmp)
  })
  return(MIs.feature)
}, mc.cores=6)


summary(sapply(MIs.per.feature,mean))
hist(sapply(MIs.per.feature,mean), main="Avg. mutual information between bound/unbound and acc. per feature ")

saveRDS(MIs.per.feature,file="../analysis/MIs.per.feature.Rds")
```

```{r}
all.features<- na.omit(as.vector(dbGetQuery(con, "SELECT DISTINCT(features) FROM tobias;"))[[1]])

MIs.score.per.feature <- mclapply(all.features, function(feature){
  feature.fetch.query <- paste("SELECT PRO1_2_score,CO1_2_score,GA1_2_score,GA3_4_score,GA5_6_score, GL1_2_score,GL3_4_score,GL5_score, PRO1_2, CO1_2, GA1_2,GA3_4,GA5_6,GL1_2,GL3_4,GL5 FROM tobias as tb, acc as ac WHERE ac.features=tb.features AND tb.features='",feature,"';",sep="")
  feat.data.tmp <- as_tibble(dbGetQuery(con, feature.fetch.query))
    
  MIs.feature <- sapply(1:nrow(feat.data.tmp),function(row.i){
  mut.tmp <- mutinformation(discretize(as.numeric(feat.data.tmp[row.i,9:16]), disc="equalwidth"), Y = discretize(as.numeric(feat.data.tmp[row.i,1:8], disc="equalwidth")))
  return(mut.tmp)
  })
  return(MIs.feature)
}, mc.cores=6)


summary(sapply(MIs.score.per.feature,mean))

saveRDS(MIs.score.per.feature,file="../analysis/MIs.per.score.feature.Rds")
```